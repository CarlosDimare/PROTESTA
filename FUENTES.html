<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FUENTES</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .slide-up {
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(10px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .sidebar-transition {
      transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
    }

    .sidebar-scroll::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar-scroll::-webkit-scrollbar-track {
      background: #18181b;
    }

    .sidebar-scroll::-webkit-scrollbar-thumb {
      background: #3f3f46;
      border-radius: 2px;
    }

    .sidebar-scroll::-webkit-scrollbar-thumb:hover {
      background: #52525b;
    }

    .translation-loading {
      background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.1), transparent);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }

      100% {
        background-position: 200% 0;
      }
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>
</head>

<body class="bg-neutral-950 text-neutral-200 selection:bg-red-700 selection:text-white">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useCallback, useMemo } from 'react';
    import { createRoot } from 'react-dom/client';
    import {
      Clock, ExternalLink, FileText, Rss, X, RefreshCw,
      Menu, ChevronLeft, Check, Globe2, AlertTriangle, Key, Info, Minus, Trash2,
      Filter, Languages, Loader2, Globe, Settings, Plus, Edit3, Save,
      Calendar as CalendarIcon, Search, ChevronRight, Users, MapPin, Calendar, Maximize2, Minimize2
    } from 'lucide-react';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SISTEMA DE TRADUCCI√ìN GRATUITO CON PROXIES CORS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const TranslationService = {
      FUENTE_LENGUAJE: {
        'La Izquierda Diario': 'es',
        'Tiempo Argentino': 'es',
        'El Pa√≠s': 'es',
        'Le Monde Diplomatique': 'es',
        'Folha de S.Paulo': 'pt',
        'Il Manifesto': 'it',
        'Il Fatto Quotidiano': 'it',
        'New York Times': 'en',
        'Democracy Now!': 'en',
        'ProPublica': 'en',
        'The Guardian': 'en',
        'Corriere della Sera': 'it',
        'Der Spiegel': 'de'
      },

      NOMBRES_IDIOMAS: {
        'es': 'Espa√±ol',
        'en': 'Ingl√©s',
        'it': 'Italiano',
        'pt': 'Portugu√©s',
        'de': 'Alem√°n',
        'fr': 'Franc√©s',
        'autodetect': 'Auto-detectado'
      },

      cache: new Map(),
      currentService: null,
      requestCount: 0,
      maxRequests: 450,
      lastReset: Date.now(),

      async traducirMyMemory(texto, idiomaOrigen = 'autodetect', idiomaDestino = 'es') {
        const cacheKey = `mymemory_${texto.substring(0, 50)}_${idiomaOrigen}_${idiomaDestino}`;
        if (this.cache.has(cacheKey)) {
          return this.cache.get(cacheKey);
        }

        const now = Date.now();
        if (now - this.lastReset > 24 * 60 * 60 * 1000) {
          this.requestCount = 0;
          this.lastReset = now;
        }

        if (this.requestCount >= this.maxRequests) {
          console.warn('L√≠mite de traducciones MyMemory alcanzado');
          return null;
        }

        try {
          const textoLimpio = texto
            .replace(/<[^>]+>/g, '')
            .replace(/&nbsp;/g, ' ')
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .trim()
            .substring(0, 500);

          if (!textoLimpio || textoLimpio.length < 3) {
            return texto;
          }

          const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(textoLimpio)}&langpair=${idiomaOrigen}|${idiomaDestino}`;

          const response = await fetch(url);
          const data = await response.json();

          this.requestCount++;

          if (data.responseStatus === 200 && data.responseData) {
            const traduccion = data.responseData.translatedText;
            this.cache.set(cacheKey, traduccion);
            if (this.cache.size > 500) {
              const firstKey = this.cache.keys().next().value;
              this.cache.delete(firstKey);
            }
            return traduccion;
          } else {
            console.warn('Error en traducci√≥n MyMemory:', data);
            return null;
          }
        } catch (error) {
          console.error('Error al traducir con MyMemory:', error);
          return null;
        }
      },

      async traducirLingva(texto, idiomaOrigen = 'auto', idiomaDestino = 'es') {
        const cacheKey = `lingva_${texto.substring(0, 50)}_${idiomaOrigen}_${idiomaDestino}`;
        if (this.cache.has(cacheKey)) {
          return this.cache.get(cacheKey);
        }

        try {
          const idiomaMap = {
            'autodetect': 'auto',
            'en': 'en',
            'es': 'es',
            'it': 'it',
            'pt': 'pt',
            'de': 'de',
            'fr': 'fr'
          };

          const sourceLang = idiomaMap[idiomaOrigen] || 'auto';
          const targetLang = idiomaMap[idiomaDestino] || 'es';

          // Lista de proxies CORS para evitar bloqueos
          const corsProxies = [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url=',
            '' // Sin proxy (para HTTPS directo)
          ];

          // Lista de instancias de Lingva
          const instances = [
            'https://lingva.ml/api/v1',
            'https://lingva.garudalinux.org/api/v1',
            'https://translate.plausibility.cloud/api/v1',
            'https://lingva.friedmann-dev.com/api/v1'
          ];

          // Combinar proxies con instancias
          const combos = [];
          for (const proxy of corsProxies) {
            for (const instance of instances) {
              combos.push({ proxy, instance });
            }
          }

          for (const { proxy, instance } of combos) {
            try {
              const encodedText = encodeURIComponent(texto);
              const url = `${proxy}${instance}/${sourceLang}/${targetLang}/${encodedText}`;

              const response = await fetch(url, {
                method: 'GET',
                headers: {
                  'Accept': 'application/json',
                }
              });

              if (response.ok) {
                const data = await response.json();
                if (data.translation) {
                  this.cache.set(cacheKey, data.translation);
                  console.log(`‚úÖ Traducci√≥n exitosa via: ${instance}`);
                  return data.translation;
                }
              }
            } catch (e) {
              console.log(`‚ö†Ô∏è Fall√≥ combo ${instance} con proxy:`, e.message);
              continue;
            }
          }

          return null;
        } catch (error) {
          console.error('Error al traducir con Lingva:', error);
          return null;
        }
      },

      async traducir(texto, idiomaOrigen = 'autodetect', idiomaDestino = 'es') {
        const cacheKey = `${texto.substring(0, 50)}_${idiomaOrigen}_${idiomaDestino}`;
        if (this.cache.has(cacheKey)) {
          return this.cache.get(cacheKey);
        }

        // Intentar con MyMemory primero
        let resultado = await this.traducirMyMemory(texto, idiomaOrigen, idiomaDestino);

        // Si MyMemory falla, usar Lingva con proxies
        if (!resultado) {
          console.log('MyMemory no disponible, usando Lingva con CORS proxy...');
          resultado = await this.traducirLingva(texto, idiomaOrigen, idiomaDestino);
        }

        if (resultado) {
          this.cache.set(cacheKey, resultado);
        }

        return resultado;
      },

      getIdiomaFuente(nombreFuente) {
        return this.FUENTE_LENGUAJE[nombreFuente] || 'unknown';
      },

      necesitaTraduccion(nombreFuente) {
        const idioma = this.getIdiomaFuente(nombreFuente);
        return idioma !== 'es' && idioma !== 'unknown';
      },

      getEstado() {
        const porcentajeUsado = Math.round((this.requestCount / this.maxRequests) * 100);
        return {
          usadas: this.requestCount,
          maximo: this.maxRequests,
          porcentaje: porcentajeUsado,
          cacheSize: this.cache.size
        };
      }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SISTEMA DE CLASIFICACI√ìN DE NOTICIAS - PERSPECTIVA DE CLASE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const ClasificadorNoticias = {
      DICCIONARIOS: {
        URGENTE: {
          vivienda: {
            palabras: ['desahucio', 'desalojo', 'lanzamiento', 'hipoteca', 'alquiler sube', 'subida alquiler',
              'okupaci√≥n', 'fondo buitre', 'blackstone', 'especulaci√≥n inmobiliaria', 'vivienda vac√≠a',
              'emergencia habitacional', 'sinhogarismo', 'ley vivienda', 'tope alquiler',
              'sfr', 'fondo fondo', 'inmobiliaria', 'precios alquiler', 'crisis habitacional',
              'eviction', 'housing', 'rent', 'homeless', 'foreclosure'],
            peso: 30
          },
          trabajo: {
            palabras: ['despido', 'despidos', 'ere', 'erte', 'cierre planta', 'deslocalizaci√≥n', 'huelga',
              'convenio colectivo', 'salario m√≠nimo', 'smi', 'jornada laboral', 'precariedad',
              'temporalidad', 'falso aut√≥nomo', 'rider', 'externalizaci√≥n', 'subcontrata',
              'accidente laboral', 'muerte trabajo', 'reforma laboral', 'paritaria', 'aumento salarial',
              'layoff', 'firing', 'strike', 'union', 'workers', 'wage', 'salary'],
            peso: 30
          },
          sanidad: {
            palabras: ['cierre hospital', 'recorte sanidad', 'privatizaci√≥n sanitaria', 'listas espera',
              'copago', 'urgencias colapsadas', 'falta m√©dicos', 'recorte plantilla', 'concierto sanitario',
              'healthcare', 'hospital', 'medical', 'nhs', 'health system'],
            peso: 30
          },
          educacion: {
            palabras: ['recorte educaci√≥n', 'cierre colegio', 'tasas universitarias', 'becas recortadas',
              'ratio alumnos', 'interinos', 'educaci√≥n concertada', 'education', 'university'],
            peso: 25
          },
          energia: {
            palabras: ['subida luz', 'precio electricidad', 'factura luz', 'pobreza energ√©tica',
              'corte suministro', 'bono social', 'precio gas', 'oligopolio el√©ctrico',
              'iberdrola', 'endesa', 'naturgy', 'energy prices', 'power', 'electricity'],
            peso: 25
          },
          pensiones: {
            palabras: ['reforma pensiones', 'revalorizaci√≥n pensiones', 'edad jubilaci√≥n', 'a√±os cotizaci√≥n',
              'pensi√≥n m√≠nima', 'recorte pensiones', 'privatizaci√≥n pensiones', 'retirement', 'pension'],
            peso: 30
          },
          represion: {
            palabras: ['detenci√≥n', 'detenido', 'carga policial', 'antidisturbios', 'ley mordaza',
              'multa manifestaci√≥n', 'criminalizaci√≥n', 'piquete', 'desalojo centro social',
              'libertad prensa', 'censura', 'police', 'arrest', 'crackdown', 'protest'],
            peso: 25
          },
          legislacion: {
            palabras: ['entra en vigor', 'ley aprobada', 'aprobado definitivamente', 'congreso vota',
              'votaci√≥n', 'reforma de', 'decreto ley', 'plazo para', '√∫ltimo d√≠a', 'bill', 'law', 'act'],
            peso: 20
          }
        },
        CLAVE: {
          poder_economico: {
            palabras: ['fondo inversi√≥n', 'private equity', 'accionista mayoritario', 'consejo administraci√≥n',
              'ibex 35', 'dividendo', 'fusi√≥n', 'adquisici√≥n', 'opa', 'blackrock', 'vanguard',
              'hedge fund', 'capital riesgo', 'investment fund', 'shareholder', 'merger', 'acquisition'],
            peso: 20
          },
          puertas_giratorias: {
            palabras: ['ex ministro', 'ex presidente', 'puerta giratoria', 'expresidente', 'exministro',
              'fichaje pol√≠tico', 'alto cargo', 'regulador', 'lobbyist', 'revolving door'],
            peso: 25
          },
          fiscalidad: {
            palabras: ['evasi√≥n fiscal', 'elusi√≥n fiscal', 'para√≠so fiscal', 'sicav', 'grandes fortunas',
              'amnist√≠a fiscal', 'panama papers', 'pandora papers', 'fraude fiscal', 'offshore',
              'tax haven', 'tax evasion', 'wealth tax', 'offshore'],
            peso: 20
          },
          estructura_poder: {
            palabras: ['propiedad de', 'qui√©n controla', 'due√±o de', 'lobby', 'financiaci√≥n partidos',
              'trama', 'red de', 'conexi√≥n entre', 'informe revela', 'investigaci√≥n demuestra',
              'ownership', 'media ownership', 'concentration'],
            peso: 20
          },
          soberania: {
            palabras: ['tratado comercial', 'cesi√≥n soberan√≠a', 'fmi', 'banco central europeo', 'bce',
              'troika', 'memor√°ndum', 'condicionalidad', 'deuda p√∫blica', 'imf', 'ecb', 'sovereign debt'],
            peso: 20
          }
        },
        IMPORTANTE: {
          contexto: {
            palabras: ['seg√∫n datos', 'informe de', 'estudio se√±ala', 'estad√≠stica', 'tasa de pobreza',
              'tasa desempleo', '√≠ndice gini', 'desigualdad', 'brecha salarial', 'report', 'study', 'data'],
            peso: 15
          },
          luchas: {
            palabras: ['sindicato', 'asamblea', 'manifestaci√≥n convocada', 'protesta', 'movilizaci√≥n',
              'plataforma ciudadana', 'colectivo', 'movimiento social', 'movement', 'activist'],
            peso: 15
          },
          internacional: {
            palabras: ['en otros pa√≠ses', 'experiencia de', 'modelo de', 'caso de', 'internationally'],
            peso: 10
          }
        },
        BASURA: {
          clickbait: {
            palabras: ['incre√≠ble', 'no te lo pierdas', 'viral', 'las redes estallan', 'arde twitter',
              'el zasca de', 'impactante', 'alucinante', 'no vas a creer', 'te sorprender√°',
              'inesperada reacci√≥n', 'estalla la guerra', 'pol√©mico v√≠deo', 'arde', 'explota',
              'shocking', 'incredible', 'you won\'t believe', 'viral'],
            peso: -30
          },
          famosos: {
            palabras: ['celebrity', 'influencer', 'tiktoker', 'youtuber', 'reality', 'gran hermano',
              'supervivientes', 'alfombra roja', 'look de', 'outfit', 'boda de', 'divorcio de',
              'romance', 'pareja de', 'ex de', 'kardashian', 'swift', 'celeb'],
            peso: -40
          },
          casa_real: {
            palabras: ['rey felipe', 'reina letizia', 'princesa leonor', 'infanta', 'casa real',
              'monarqu√≠a', 'corona espa√±ola', 'royal', 'king', 'queen', 'prince', 'monarchy'],
            peso: -30
          },
          deportes_espectaculo: {
            palabras: ['fichaje', 'gol de', 'champions', 'liga de f√∫tbol', 'mundial f√∫tbol',
              'bal√≥n de oro', 'selecci√≥n', 'entrenador destituido', 'cl√°sico',
              'transfer', 'goal', 'world cup', 'champions league', 'football', 'soccer'],
            peso: -25
          },
          especulacion: {
            palabras: ['podr√≠a ser', 'se rumorea', 'fuentes cercanas', 'seg√∫n parece', 'no descarta',
              'estar√≠a considerando', 'se espera que', 'posiblemente', 'might', 'could', 'rumored'],
            peso: -15
          },
          relleno: {
            palabras: ['ha declarado que', 'se reunir√°n para', 'estudiar√°n la posibilidad',
              'ha mostrado partidario', 'en los pr√≥ximos meses', 'agenda incluye'],
            peso: -10
          }
        },
        PROPAGANDA: {
          exito_individual: {
            palabras: ['emprendedor', 'self-made', 'joven triunfa', 'historia de √©xito', 'lo logr√≥ solo',
              'sin ayuda de nadie', 'desde cero', 'millonario joven', 'entrepreneur', 'self-made', 'success story'],
            peso: -25
          },
          nacionalismo_vacio: {
            palabras: ['espa√±a va bien', 'orgullo nacional', 'somos los mejores', 'espa√±a lidera',
              'recuperaci√≥n econ√≥mica', 'el pa√≠s avanza', 'great again', 'recovery', 'growth'],
            peso: -20
          },
          miedo_sin_solucion: {
            palabras: ['invasi√≥n', 'oleada', 'avalancha de inmigrantes', 'inseguridad ciudadana',
              'ola de robos', 'criminalidad aumenta', 'invasion', 'crime wave', 'security'],
            peso: -30
          }
        }
      },
      FUENTES: {
        positivas: {
          'el salto': 15, 'la marea': 15, 'ctxt': 10, 'p√∫blico': 5, 'eldiario': 5,
          'la izquierda diario': 10, 'p√°gina/12': 10, 'le monde diplomatique': 15,
          'the guardian': 5, 'jacobin': 15, 'new york times': 0, 'reuters': 5, 'efe': 5, 'afp': 5,
          'democracy now!': 10, 'propublica': 15, 'tiempo argentino': 5, 'der spiegel': 10,
          'folha de s.paulo': 5, 'il manifesto': 15, 'il fatto quotidiano': 10
        },
        negativas: {
          'ok diario': -20, 'libertad digital': -15, 'la raz√≥n': -10, 'abc': -10,
          'el mundo': -5, 'el confidencial': -5, 'expansi√≥n': -10, 'cinco d√≠as': -10
        }
      },
      clasificar(noticia) {
        const texto = `${noticia.title} ${noticia.description}`.toLowerCase();
        const fuente = noticia.source.toLowerCase();
        let puntuacion = 50;
        let indicadoresEncontrados = [];
        let temasDetectados = [];

        const esBasuraObvia = this.detectarBasuraObvia(texto);
        if (esBasuraObvia.esBasura) {
          return {
            etiqueta: 'BASURA', emoji: '‚ö´', puntuacion: esBasuraObvia.puntuacion,
            indicadores: esBasuraObvia.indicadores, temas: ['contenido_descartable'],
            justificacion: esBasuraObvia.justificacion, confianza: 'ALTA'
          };
        }

        for (const [categoria, data] of Object.entries(this.DICCIONARIOS.URGENTE)) {
          const coincidencias = this.buscarCoincidencias(texto, data.palabras);
          if (coincidencias.length > 0) {
            puntuacion += data.peso;
            indicadoresEncontrados.push(...coincidencias);
            temasDetectados.push(categoria);
          }
        }

        for (const [categoria, data] of Object.entries(this.DICCIONARIOS.CLAVE)) {
          const coincidencias = this.buscarCoincidencias(texto, data.palabras);
          if (coincidencias.length > 0) {
            puntuacion += data.peso;
            indicadoresEncontrados.push(...coincidencias);
            temasDetectados.push(categoria);
          }
        }

        for (const [categoria, data] of Object.entries(this.DICCIONARIOS.IMPORTANTE)) {
          const coincidencias = this.buscarCoincidencias(texto, data.palabras);
          if (coincidencias.length > 0) {
            puntuacion += data.peso;
            indicadoresEncontrados.push(...coincidencias);
            temasDetectados.push(categoria);
          }
        }

        for (const [categoria, data] of Object.entries(this.DICCIONARIOS.BASURA)) {
          const coincidencias = this.buscarCoincidencias(texto, data.palabras);
          if (coincidencias.length > 0) {
            puntuacion += data.peso;
            indicadoresEncontrados.push(...coincidencias.map(c => `‚ö†Ô∏è${c}`));
          }
        }

        for (const [categoria, data] of Object.entries(this.DICCIONARIOS.PROPAGANDA)) {
          const coincidencias = this.buscarCoincidencias(texto, data.palabras);
          if (coincidencias.length > 0) {
            puntuacion += data.peso;
            indicadoresEncontrados.push(...coincidencias.map(c => `üö©${c}`));
          }
        }

        let modFuente = 0;
        for (const [nombreFuente, mod] of Object.entries(this.FUENTES.positivas)) {
          if (fuente.includes(nombreFuente)) { modFuente = mod; break; }
        }
        if (modFuente === 0) {
          for (const [nombreFuente, mod] of Object.entries(this.FUENTES.negativas)) {
            if (fuente.includes(nombreFuente)) { modFuente = mod; break; }
          }
        }
        puntuacion += modFuente;

        if (noticia.title.includes('?')) { puntuacion -= 10; indicadoresEncontrados.push('‚ö†Ô∏ètitular_interrogativo'); }
        if (/a partir del|entra en vigor|hasta el d√≠a|plazo de \d+/i.test(texto)) { puntuacion += 15; indicadoresEncontrados.push('üìÖfecha_l√≠mite'); }
        if (/\d+%|\d+ (millones|euros|d√≥lares|personas|trabajadores)/i.test(texto)) { puntuacion += 10; indicadoresEncontrados.push('üìädatos_cuantificables'); }

        puntuacion = Math.max(0, Math.min(100, puntuacion));
        const clasificacion = this.asignarEtiqueta(puntuacion);
        const justificacion = this.generarJustificacion(clasificacion.etiqueta, temasDetectados, indicadoresEncontrados);

        return { ...clasificacion, puntuacion, indicadores: indicadoresEncontrados, temas: temasDetectados, justificacion, modFuente, confianza: this.calcularConfianza(indicadoresEncontrados.length, puntuacion) };
      },
      detectarBasuraObvia(texto) {
        const patronesBasura = [
          { patron: /gran hermano|supervivientes|la isla|reality/i, razon: 'Reality show' },
          { patron: /hor√≥scopo|tarot|predicci√≥n zodiac/i, razon: 'Pseudociencia' },
          { patron: /look de|outfit|alfombra roja|vestido de/i, razon: 'Moda/espect√°culo' },
          { patron: /kim kardashian|taylor swift|bad bunny|shakira|kylie|kendall/i, razon: 'Celebrity' },
          { patron: /el zasca|arde twitter|las redes estallan/i, razon: 'Clickbait redes' },
          { patron: /video viral|se hace viral|tiktok viral/i, razon: 'Viralidad vac√≠a' }
        ];
        for (const { patron, razon } of patronesBasura) {
          if (patron.test(texto)) {
            return { esBasura: true, puntuacion: 5, indicadores: [razon], justificacion: `Descartado: ${razon}. No aporta informaci√≥n √∫til.` };
          }
        }
        return { esBasura: false };
      },
      buscarCoincidencias(texto, palabras) {
        const encontradas = [];
        for (const palabra of palabras) {
          const regex = new RegExp(palabra.replace(/\s+/g, '\\s+'), 'i');
          if (regex.test(texto)) { encontradas.push(palabra); }
        }
        return encontradas;
      },
      asignarEtiqueta(puntuacion) {
        if (puntuacion >= 80) return { etiqueta: 'URGENTE', emoji: 'üî¥', color: 'red' };
        if (puntuacion >= 60) return { etiqueta: 'CLAVE', emoji: 'üü†', color: 'orange' };
        if (puntuacion >= 40) return { etiqueta: 'IMPORTANTE', emoji: 'üü°', color: 'yellow' };
        if (puntuacion >= 20) return { etiqueta: 'RELLENO', emoji: '‚ö™', color: 'gray' };
        return { etiqueta: 'BASURA', emoji: '‚ö´', color: 'black' };
      },
      generarJustificacion(etiqueta, temas, indicadores) {
        const temasStr = temas.length > 0 ? temas.slice(0, 3).join(', ') : 'general';
        switch (etiqueta) {
          case 'URGENTE': return `Afecta directamente condiciones materiales. Temas: ${temasStr}. Requiere atenci√≥n inmediata.`;
          case 'CLAVE': return `Revela estructuras de poder o mecanismos del sistema. Temas: ${temasStr}.`;
          case 'IMPORTANTE': return `Aporta contexto o datos relevantes sobre: ${temasStr}.`;
          case 'RELLENO': return `Informaci√≥n sin impacto directo. No requiere acci√≥n.`;
          case 'BASURA': return `Distracci√≥n o contenido sin valor informativo. Ignorar.`;
          default: return '';
        }
      },
      calcularConfianza(numIndicadores, puntuacion) {
        if (numIndicadores >= 3 && (puntuacion >= 75 || puntuacion <= 25)) return 'ALTA';
        if (numIndicadores >= 1) return 'MEDIA';
        return 'BAJA';
      }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FLAGS SVG - BANDERAS CORREGIDAS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const FlagArgentina = () => (
      <svg viewBox="0 0 640 480" className="w-5 h-4 rounded-sm shadow-sm">
        <g fillRule="evenodd" strokeWidth="1pt">
          <path fill="#74acdf" d="M0 0h640v153.6H0z" />
          <path fill="#fff" d="M0 153.6h640v172.8H0z" />
          <path fill="#74acdf" d="M0 326.4h640V480H0z" />
          <path fill="#f6b40e" d="M256 160l36.8 113.2-96.5-70.1h119.4l-96.5 70.1z" />
        </g>
      </svg>
    );
    const FlagBrazil = () => (
      <svg viewBox="0 0 640 480" className="w-5 h-4 rounded-sm shadow-sm">
        <g fillRule="evenodd" strokeWidth="1pt">
          <path fill="#009c3b" d="M0 0h640v480H0z" />
          <path fill="#ffdf00" d="M320 60L54 240l266 180 266-180z" />
          <path fill="#002776" d="M319.5 140c-55.3 0-100 45.3-100 101.3s44.7 101.3 100 101.3 100-45.3 100-101.3-44.7-101.3-100-101.3z" stroke="#002776" strokeWidth="8" />
        </g>
      </svg>
    );
    const FlagItaly = () => (
      <svg viewBox="0 0 640 480" className="w-5 h-4 rounded-sm shadow-sm">
        <g fillRule="evenodd" strokeWidth="1pt">
          <path fill="#009246" d="M0 0h213.3v480H0z" />
          <path fill="#fff" d="M213.3 0h213.4v480H213.3z" />
          <path fill="#ce2b37" d="M426.7 0H640v480H426.7z" />
        </g>
      </svg>
    );
    const FlagUSA = () => (
      <svg viewBox="0 0 640 480" className="w-5 h-4 rounded-sm shadow-sm">
        <path fill="#bd3d44" d="M0 0h640v480H0z" />
        <path fill="#fff" d="M0 37h640v37H0zm0 73.9h640v37H0zm0 74h640v37H0zm0 73.8h640v37H0zm0 74.1h640v37H0zm0 73.8h640v37H0z" />
        <path fill="#192f5d" d="M0 0h256v259.3H0z" />
      </svg>
    );
    const FlagUK = () => (
      <svg viewBox="0 0 640 480" className="w-5 h-4 rounded-sm shadow-sm">
        <path fill="#012169" d="M0 0h640v480H0z" />
        <path fill="#fff" d="M75 0l244 181L563 0h77v62L400 241l240 178v61h-80L320 301 81 480H0v-60l239-178L0 64V0h75z" />
        <path fill="#c8102e" d="M424 281l216 159v40L369 281h55zm-184 20l6 35L54 480H0l240-179-6-35h6zm336 0l6 35L545 480H640L400 301l-6-35h6z" />
        <path fill="#fff" d="M241 0v480h160V0H241zM0 160v160h640V160H0z" />
        <path fill="#c8102e" d="M273 0v480h96V0H273zM0 193v94h640v-94H0z" />
      </svg>
    );
    const FlagFrance = () => (
      <svg viewBox="0 0 640 480" className="w-5 h-4 rounded-sm shadow-sm">
        <path fill="#fff" d="M0 0h640v480H0z" />
        <path fill="#00267f" d="M0 0h213.3v480H0z" />
        <path fill="#f31830" d="M426.7 0H640v480H426.7z" />
      </svg>
    );
    const FlagSpain = () => (
      <svg viewBox="0 0 640 480" className="w-5 h-4 rounded-sm shadow-sm">
        <g fillRule="evenodd" strokeWidth="1pt">
          <path fill="#aa151b" d="M0 0h640v480H0z" />
          <path fill="#f1bf00" d="M0 128h640v224H0z" />
        </g>
      </svg>
    );
    // BANDERA ALEMANIA CORREGIDA
    const FlagGermany = () => (
      <svg viewBox="0 0 5 3" className="w-5 h-4 rounded-sm shadow-sm">
        <rect width="5" height="3" fill="#000" />
        <rect width="5" height="2" y="1" fill="#d00" />
        <rect width="5" height="1" y="2" fill="#ffce00" />
      </svg>
    );
    // BANDERA QATAR CORREGIDA
    const FlagQatar = () => (
      <svg viewBox="0 0 28 11" className="w-5 h-4 rounded-sm shadow-sm">
        <rect width="28" height="11" fill="#8d1b3d" />
        <path fill="#fff" d="M0 0h8l2 0.5L8 1l2 0.5L8 2l2 0.5L8 3l2 0.5L8 4l2 0.5L8 5l2 0.5L8 6l2 0.5L8 7l2 0.5L8 8l2 0.5L8 9l2 0.5L8 10l2 0.5L8 11H0z" />
      </svg>
    );
    // BANDERA AUSTRALIA CORREGIDA
    const FlagAustralia = () => (
      <svg viewBox="0 0 640 480" className="w-5 h-4 rounded-sm shadow-sm">
        <path fill="#00008b" d="M0 0h640v480H0z" />
        {/* Union Jack Simplificado */}
        <path fill="#fff" d="M0 0l160 120M0 240l160-120M240 0v240M0 120h240" strokeWidth="30" stroke="#fff" />
        <path fill="none" d="M0 0l160 120M0 240l160-120M240 0v240M0 120h240" strokeWidth="18" stroke="#c8102e" />
        {/* Estrellas (Commonwealth + Southern Cross) */}
        <g fill="#fff">
          <circle cx="160" cy="360" r="40" /> {/* Commonwealth Star */}
          <circle cx="480" cy="120" r="14" />
          <circle cx="450" cy="205" r="14" />
          <circle cx="480" cy="260" r="14" />
          <circle cx="560" cy="180" r="14" />
          <circle cx="510" cy="230" r="8" />
        </g>
      </svg>
    );
    // BANDERA SUD√ÅFRICA CORREGIDA
    const FlagSouthAfrica = () => (
      <svg viewBox="0 0 900 600" className="w-5 h-4 rounded-sm shadow-sm">
        {/* Fondo Rojo (Arriba) y Azul (Abajo) */}
        <path fill="#de3831" d="M0 0h900v300H0z" />
        <path fill="#002395" d="M0 300h900v300H0z" />

        {/* La Y Blanca (Fondo de la Y verde) */}
        <path fill="#fff" d="M0 0l450 300L0 600v-80l340-220L0 80z" />
        <rect x="400" y="240" width="500" height="120" fill="#fff" />

        {/* La Y Verde Central */}
        <path fill="#007749" d="M0 35l390 265L0 565v-65l300-200L0 100z" />
        <rect x="380" y="260" width="520" height="80" fill="#007749" />

        {/* Tri√°ngulos Izquierda (Amarillo y Negro) */}
        <path fill="#ffb81c" d="M0 50l330 250L0 550z" />
        <path fill="#000" d="M0 100l260 200L0 500z" />
      </svg>
    );
    const getFlag = (country) => {
      switch (country) {
        case 'AR': return <FlagArgentina />;
        case 'BR': return <FlagBrazil />;
        case 'IT': return <FlagItaly />;
        case 'US': return <FlagUSA />;
        case 'UK': return <FlagUK />;
        case 'FR': return <FlagFrance />;
        case 'ES': return <FlagSpain />;
        case 'DE': return <FlagGermany />;
        case 'QA': return <FlagQatar />;
        case 'AU': return <FlagAustralia />;
        case 'ZA': return <FlagSouthAfrica />;
        default: return <Globe2 className="w-5 h-4 text-neutral-500" />;
      }
    };
    // Funci√≥n auxiliar para obtener el pa√≠s de una fuente
    const getCountryBySource = (sourceName) => {
      const countryMap = {
        'La Izquierda Diario': 'AR',
        'Tiempo Argentino': 'AR',
        'Folha de S.Paulo': 'BR',
        'Democracy Now!': 'US',
        'New York Times': 'US',
        'ProPublica': 'US',
        'The Guardian': 'UK',
        'El Pa√≠s': 'ES',
        'Corriere della Sera': 'IT',
        'Il Manifesto': 'IT',
        'Il Fatto Quotidiano': 'IT',
        'Der Spiegel': 'DE',
        'Le Monde Diplomatique': 'FR'
      };
      return countryMap[sourceName] || null;
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUENTES POR DEFECTO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const DEFAULT_SOURCES = [
      // --- AM√âRICA DEL SUR ---
      { name: 'La Izquierda Diario', country: 'AR', url: 'https://www.laizquierdadiario.com/spip.php?page=backend' },
      { name: 'Tiempo Argentino', country: 'AR', url: 'https://www.tiempoar.com.ar/articulos/feed' },
      { name: 'Folha de S.Paulo', country: 'BR', url: 'https://feeds.folha.uol.com.br/mundo/rss091.xml' },

      // --- EUROPA ---
      { name: 'Il Manifesto', country: 'IT', url: 'https://ilmanifesto.it/feed/' },
      { name: 'Il Fatto Quotidiano', country: 'IT', url: 'https://www.ilfattoquotidiano.it/feed/' },
      { name: 'Corriere della Sera', country: 'IT', url: 'https://xml2.corriereobjects.it/feed-hp/homepage.xml' },
      { name: 'Der Spiegel', country: 'DE', url: 'https://www.spiegel.de/international/index.rss' },
      { name: 'El Pa√≠s', country: 'ES', url: 'https://feeds.elpais.com/mrss-s/pages/ep/site/elpais.com/portada' },
      { name: 'Le Monde Diplomatique', country: 'FR', url: 'https://mondiplo.com/spip.php?page=backend' },
      { name: 'The Guardian', country: 'UK', url: 'https://www.theguardian.com/world/rss' },

      // --- AM√âRICA DEL NORTE ---
      { name: 'Democracy Now!', country: 'US', url: 'https://www.democracynow.org/democracynow.rss' },
      { name: 'New York Times', country: 'US', url: 'https://rss.nytimes.com/services/xml/rss/nyt/World.xml' },
      { name: 'ProPublica', country: 'US', url: 'https://feeds.propublica.org/propublica/main' }
    ];

    const loadSources = () => {
      try {
        const stored = localStorage.getItem('declase_sources');
        return stored ? JSON.parse(stored) : DEFAULT_SOURCES;
      } catch (e) {
        return DEFAULT_SOURCES;
      }
    };

    const saveSources = (sources) => {
      try {
        localStorage.setItem('declase_sources', JSON.stringify(sources));
      } catch (e) {
        console.error('Error guardando fuentes:', e);
      }
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COMPONENTES UI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const ClasificacionBadge = ({ clasificacion, showDetails = false }) => {
      const colores = {
        URGENTE: 'bg-red-600 text-white border-red-500',
        CLAVE: 'bg-orange-600 text-white border-orange-500',
        IMPORTANTE: 'bg-yellow-600 text-black border-yellow-500',
        RELLENO: 'bg-neutral-500 text-white border-neutral-400',
        BASURA: 'bg-neutral-800 text-neutral-400 border-neutral-700'
      };
      const iconos = {
        URGENTE: <AlertTriangle className="w-3 h-3" />,
        CLAVE: <Key className="w-3 h-3" />,
        IMPORTANTE: <Info className="w-3 h-3" />,
        RELLENO: <Minus className="w-3 h-3" />,
        BASURA: <Trash2 className="w-3 h-3" />
      };
      return (
        <div className="flex items-center gap-2">
          <span className={`inline-flex items-center gap-1 px-2 py-0.5 text-[10px] font-black uppercase tracking-wider border ${colores[clasificacion.etiqueta]}`}>
            {iconos[clasificacion.etiqueta]}
            {clasificacion.emoji} {clasificacion.etiqueta}
          </span>
          {showDetails && (
            <span className="text-[9px] text-neutral-500 font-mono">
              {clasificacion.puntuacion}pts | {clasificacion.confianza}
            </span>
          )}
        </div>
      );
    };



    const SourceEditor = ({ source, onSave, onCancel }) => {
      const [name, setName] = useState(source?.name || '');
      const [url, setUrl] = useState(source?.url || '');
      const [country, setCountry] = useState(source?.country || 'US');

      useEffect(() => {
        if (source) {
          setName(source.name || '');
          setUrl(source.url || '');
          setCountry(source.country || 'US');
        }
      }, [source]);

      const countries = [
        { code: 'AR', name: 'Argentina' },
        { code: 'BR', name: 'Brasil' },
        { code: 'DE', name: 'Alemania' },
        { code: 'ES', name: 'Espa√±a' },
        { code: 'FR', name: 'Francia' },
        { code: 'IT', name: 'Italia' },
        { code: 'QA', name: 'Qatar' },
        { code: 'UK', name: 'Reino Unido' },
        { code: 'US', name: 'Estados Unidos' },
        { code: 'AU', name: 'Australia' },
        { code: 'ZA', name: 'Sud√°frica' },
        { code: 'MX', name: 'M√©xico' },
        { code: 'CL', name: 'Chile' },
        { code: 'CO', name: 'Colombia' }
      ];

      const handleSubmit = (e) => {
        e.preventDefault();
        if (name.trim() && url.trim()) {
          onSave({ name: name.trim(), url: url.trim(), country });
        }
      };

      return (
        <div className="p-4 bg-neutral-950 border-t border-neutral-800">
          <h4 className="text-xs font-bold text-white uppercase tracking-wider mb-3">
            {source ? 'Editar Fuente' : 'Agregar Fuente'}
          </h4>
          <form onSubmit={handleSubmit} className="space-y-3">
            <div>
              <label className="text-[10px] text-neutral-500 uppercase font-bold block mb-1">Nombre</label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="w-full bg-neutral-900 border border-neutral-700 text-white text-sm px-3 py-2 focus:outline-none focus:border-red-600"
                placeholder="Ej: El Pa√≠s"
                required
              />
            </div>
            <div>
              <label className="text-[10px] text-neutral-500 uppercase font-bold block mb-1">URL del RSS</label>
              <input
                type="url"
                value={url}
                onChange={(e) => setUrl(e.target.value)}
                className="w-full bg-neutral-900 border border-neutral-700 text-white text-sm px-3 py-2 focus:outline-none focus:border-red-600 font-mono"
                placeholder="https://..."
                required
              />
            </div>
            <div>
              <label className="text-[10px] text-neutral-500 uppercase font-bold block mb-1">Pa√≠s</label>
              <select
                value={country}
                onChange={(e) => setCountry(e.target.value)}
                className="w-full bg-neutral-900 border border-neutral-700 text-white text-sm px-3 py-2 focus:outline-none focus:border-red-600"
              >
                {countries.map(c => (
                  <option key={c.code} value={c.code}>{c.name}</option>
                ))}
              </select>
            </div>
            <div className="flex gap-2 pt-2">
              <button
                type="submit"
                className="flex-1 bg-red-700 hover:bg-red-600 text-white text-xs font-bold uppercase py-2 flex items-center justify-center gap-1"
              >
                <Save className="w-3 h-3" /> Guardar
              </button>
              <button
                type="button"
                onClick={onCancel}
                className="flex-1 bg-neutral-800 hover:bg-neutral-700 text-neutral-400 text-xs font-bold uppercase py-2"
              >
                Cancelar
              </button>
            </div>
          </form>
        </div>
      );
    };

    const SourcesSidebar = ({ sources, selectedSources, onToggleSource, onToggleAll, isOpen, onClose, onUpdateSources }) => {
      const [showConfig, setShowConfig] = useState(false);
      const [editingSource, setEditingSource] = useState(null);
      const [allSelected, setAllSelected] = useState(false);

      useEffect(() => {
        setAllSelected(sources.length > 0 && sources.every(s => selectedSources.has(s.name)));
      }, [sources, selectedSources]);

      const handleAddSource = () => {
        setEditingSource(null);
        setShowConfig(true);
      };

      const handleEditSource = (source) => {
        setEditingSource(source);
        setShowConfig(true);
      };

      const handleDeleteSource = (sourceName) => {
        if (window.confirm(`¬øEliminar la fuente "${sourceName}"?`)) {
          const updated = sources.filter(s => s.name !== sourceName);
          onUpdateSources(updated);
        }
      };

      const handleSaveSource = (sourceData) => {
        let updated;
        if (editingSource) {
          updated = sources.map(s => s.name === editingSource.name ? sourceData : s);
        } else {
          if (sources.some(s => s.name === sourceData.name)) {
            alert('Ya existe una fuente con ese nombre');
            return;
          }
          updated = [...sources, sourceData];
        }
        onUpdateSources(updated);
        setShowConfig(false);
        setEditingSource(null);
      };

      const handleRestoreDefaults = () => {
        if (window.confirm('¬øRestaurar las fuentes por defecto? Se perder√°n las personalizaciones.')) {
          onUpdateSources(DEFAULT_SOURCES);
        }
      };

      const handleToggleAll = () => {
        onToggleAll(!allSelected);
      };

      return (
        <>
          {isOpen && <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-30 md:hidden fade-in" onClick={onClose} />}
          <aside className={`fixed left-0 top-16 bottom-0 z-40 bg-neutral-900 border-r border-neutral-800 flex flex-col sidebar-transition w-80 ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
            <div className="flex flex-col h-full">
              <div className="p-4 border-b border-neutral-800 flex justify-between items-center bg-neutral-950">
                <h3 className="text-sm font-black text-white uppercase tracking-wider flex items-center gap-2">
                  <Rss className="w-4 h-4 text-red-500" /> Fuentes
                </h3>
                <div className="flex items-center gap-1">
                  <button
                    onClick={handleAddSource}
                    className="text-neutral-500 hover:text-red-500 p-1 hover:bg-neutral-800 rounded transition-colors"
                    title="Agregar fuente"
                  >
                    <Plus className="w-4 h-4" />
                  </button>
                  <button
                    onClick={() => setShowConfig(!showConfig)}
                    className={`text-neutral-500 hover:text-white p-1 hover:bg-neutral-800 rounded transition-colors ${showConfig ? 'bg-red-900/30 text-red-500' : ''}`}
                    title="Configuraci√≥n"
                  >
                    <Settings className="w-4 h-4" />
                  </button>
                  <button onClick={onClose} className="text-neutral-500 hover:text-white p-1 hover:bg-neutral-800 rounded transition-colors">
                    <X className="w-5 h-5" />
                  </button>
                </div>
              </div>

              {!showConfig ? (
                <>
                  <div className="p-3 border-b border-neutral-800 bg-neutral-950/50">
                    <button
                      onClick={handleToggleAll}
                      className="w-full text-[10px] text-neutral-400 hover:text-white uppercase font-bold py-2 px-3 bg-neutral-800 hover:bg-neutral-700 rounded transition-colors flex items-center justify-center gap-2"
                    >
                      {allSelected ? (
                        <>
                          <X className="w-3 h-3" /> Deseleccionar todas
                        </>
                      ) : (
                        <>
                          <Check className="w-3 h-3" /> Seleccionar todas
                        </>
                      )}
                    </button>
                  </div>

                  <div className="flex-1 overflow-y-auto sidebar-scroll p-3 space-y-1">
                    {sources.map((source) => {
                      const idioma = TranslationService.getIdiomaFuente(source.name);
                      const necesitaTraduccion = TranslationService.necesitaTraduccion(source.name);
                      return (
                        <div key={source.name} className="group">
                          <button
                            onClick={() => onToggleSource(source.name)}
                            className={`w-full flex items-center gap-3 p-3 rounded-lg transition-all text-left ${selectedSources.has(source.name)
                              ? 'bg-red-900/20 border border-red-800/50 text-red-100'
                              : 'bg-neutral-800/50 border border-neutral-700/50 text-neutral-400 hover:bg-neutral-800 hover:text-neutral-300'
                              }`}
                          >
                            <div className="shrink-0">{getFlag(source.country)}</div>
                            <div className="flex-1 min-w-0">
                              <div className="text-sm font-bold truncate flex items-center gap-2">
                                {source.name}
                                {necesitaTraduccion && (
                                  <span className="inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-blue-900/50 text-blue-300 text-[8px] font-bold uppercase rounded border border-blue-800">
                                    <Languages className="w-2.5 h-2.5" /> {idioma}
                                  </span>
                                )}
                              </div>
                              <div className="text-[10px] uppercase tracking-wider opacity-60 truncate">
                                {source.country}
                              </div>
                            </div>
                            <div className={`w-5 h-5 rounded flex items-center justify-center shrink-0 ${selectedSources.has(source.name) ? 'bg-red-600 text-white' : 'bg-neutral-700 text-transparent'
                              }`}>
                              <Check className="w-3 h-3" />
                            </div>
                          </button>
                        </div>
                      );
                    })}
                  </div>

                  <div className="p-3 border-t border-neutral-800 bg-neutral-950 space-y-2">
                    <div className="text-[10px] text-neutral-500 text-center font-mono uppercase">
                      {selectedSources.size} de {sources.length} fuentes activas
                    </div>
                    <button
                      onClick={handleRestoreDefaults}
                      className="w-full text-[9px] text-neutral-600 hover:text-red-500 uppercase font-bold underline"
                    >
                      Restaurar fuentes por defecto
                    </button>
                  </div>
                </>
              ) : (
                <>
                  <div className="flex-1 overflow-y-auto sidebar-scroll p-3 space-y-1">
                    {sources.map((source) => (
                      <div
                        key={source.name}
                        className="group flex items-center gap-3 p-3 bg-neutral-800/50 border border-neutral-700/50 rounded-lg hover:border-neutral-600 transition-all"
                      >
                        <div className="shrink-0">{getFlag(source.country)}</div>
                        <div className="flex-1 min-w-0">
                          <div className="text-sm font-bold truncate text-neutral-300">{source.name}</div>
                          <div className="text-[9px] text-neutral-500 font-mono truncate">{source.url}</div>
                        </div>
                        <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                          <button
                            onClick={() => handleEditSource(source)}
                            className="text-neutral-500 hover:text-red-500 p-1 hover:bg-neutral-700 rounded"
                            title="Editar"
                          >
                            <Edit3 className="w-3 h-3" />
                          </button>
                          <button
                            onClick={() => handleDeleteSource(source.name)}
                            className="text-neutral-500 hover:text-red-500 p-1 hover:bg-neutral-700 rounded"
                            title="Eliminar"
                          >
                            <Trash2 className="w-3 h-3" />
                          </button>
                        </div>
                      </div>
                    ))}
                    {sources.length === 0 && (
                      <div className="text-center py-8 text-neutral-600 text-sm">
                        No hay fuentes configuradas
                      </div>
                    )}
                  </div>

                  <div className="p-3 border-t border-neutral-800 bg-neutral-950">
                    <button
                      onClick={handleAddSource}
                      className="w-full bg-red-700 hover:bg-red-600 text-white text-xs font-bold uppercase py-2 flex items-center justify-center gap-2"
                    >
                      <Plus className="w-4 h-4" /> Agregar Nueva Fuente
                    </button>
                  </div>
                </>
              )}

              {showConfig && (
                <SourceEditor
                  source={editingSource}
                  onSave={handleSaveSource}
                  onCancel={() => {
                    setShowConfig(false);
                    setEditingSource(null);
                  }}
                />
              )}
            </div>
          </aside>
        </>
      );
    };

    const FiltrosClasificacion = ({ filtroActivo, onFiltrar, conteos }) => {
      const filtros = [
        { key: 'TODOS', label: 'Todos', emoji: 'üì∞', color: 'bg-neutral-700' },
        { key: 'URGENTE', label: 'Urgente', emoji: 'üî¥', color: 'bg-red-600' },
        { key: 'CLAVE', label: 'Clave', emoji: 'üü†', color: 'bg-orange-600' },
        { key: 'IMPORTANTE', label: 'Importante', emoji: 'üü°', color: 'bg-yellow-600' },
        { key: 'RELLENO', label: 'Relleno', emoji: '‚ö™', color: 'bg-neutral-500' },
        { key: 'BASURA', label: 'Basura', emoji: '‚ö´', color: 'bg-neutral-800' }
      ];
      return (
        <div className="flex flex-wrap gap-2 p-4 bg-neutral-900/50 border-b border-neutral-800">
          <span className="text-[10px] text-neutral-500 uppercase tracking-wider flex items-center gap-1 mr-2">
            <Filter className="w-3 h-3" /> Filtrar:
          </span>
          {filtros.map(f => (
            <button
              key={f.key}
              onClick={() => onFiltrar(f.key)}
              className={`px-3 py-1 text-[11px] font-bold uppercase tracking-wider rounded-full transition-all flex items-center gap-1 ${filtroActivo === f.key ? `${f.color} text-white shadow-lg` : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700'}`}
            >
              {f.emoji} {f.label}
              <span className="ml-1 opacity-70">({conteos[f.key] || 0})</span>
            </button>
          ))}
        </div>
      );
    };

    const TranslationToggle = ({ item, traduccion, cargando, onAlternar, mostrarOriginal }) => {
      const idioma = TranslationService.getIdiomaFuente(item.source);
      const nombreIdioma = TranslationService.NOMBRES_IDIOMAS[idioma] || idioma;
      const necesitaTraduccion = TranslationService.necesitaTraduccion(item.source);

      if (!necesitaTraduccion) return null;

      const itemId = `${item.link}-${item.pubDate}`;
      const estaTraducido = traduccion && !mostrarOriginal;

      return (
        <div className="flex items-center gap-2 mb-2">
          {estaTraducido ? (
            <>
              <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-900/30 text-green-400 text-[9px] font-bold uppercase rounded border border-green-900/50">
                <Languages className="w-3 h-3" /> Traducido del {nombreIdioma}
              </span>
              <button
                onClick={() => onAlternar(itemId)}
                className="text-[9px] text-neutral-400 hover:text-white underline"
              >
                Ver original en {nombreIdioma}
              </button>
            </>
          ) : cargando ? (
            <>
              <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-900/30 text-blue-400 text-[9px] font-bold uppercase rounded border border-blue-900/50">
                <Globe className="w-3 h-3" /> {nombreIdioma}
              </span>
              <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-red-900/30 text-red-400 text-[9px] font-bold uppercase rounded border border-red-900/50">
                <Loader2 className="w-3 h-3 animate-spin" /> Traduciendo...
              </span>
            </>
          ) : (
            <>
              <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-900/30 text-blue-400 text-[9px] font-bold uppercase rounded border border-blue-900/50">
                <Globe className="w-3 h-3" /> Original en {nombreIdioma}
              </span>
              {traduccion && (
                <button
                  onClick={() => onAlternar(itemId)}
                  className="text-[9px] text-red-400 hover:text-red-300 underline font-bold"
                >
                  Ver traducci√≥n al espa√±ol
                </button>
              )}
            </>
          )}
        </div>
      );
    };

    const NewsFeed = ({ news, loading, error, onRefresh }) => {
      const [selectedNews, setSelectedNews] = useState(null);
      const [filtroActivo, setFiltroActivo] = useState('TODOS');
      const [traducciones, setTraducciones] = useState({});
      const [cargandoTraduccion, setCargandoTraduccion] = useState({});
      const [mostrarOriginal, setMostrarOriginal] = useState({});
      const [traduciendoCount, setTraduciendoCount] = useState(0);
      const [totalParaTraducir, setTotalParaTraducir] = useState(0);
      const [ordenPorPuntuacion, setOrdenPorPuntuacion] = useState(false); // false = cronol√≥gico por defecto
      const [busqueda, setBusqueda] = useState('');

      // Traducir autom√°ticamente todas las noticias al cargar
      useEffect(() => {
        const traducirAutomaticamente = async () => {
          const noticiasParaTraducir = news.filter(item =>
            TranslationService.necesitaTraduccion(item.source)
          );

          if (noticiasParaTraducir.length === 0) return;

          setTotalParaTraducir(noticiasParaTraducir.length);
          setTraduciendoCount(0);

          // Inicializar mostrarOriginal en false (mostrar traducci√≥n) para todas
          setMostrarOriginal(prev => {
            const nuevo = { ...prev };
            noticiasParaTraducir.forEach(item => {
              const itemId = `${item.link}-${item.pubDate}`;
              nuevo[itemId] = false;
            });
            return nuevo;
          });

          // Traducir en lotes de 2 para mejor rendimiento con proxies
          for (let i = 0; i < noticiasParaTraducir.length; i += 2) {
            const lote = noticiasParaTraducir.slice(i, i + 2);

            await Promise.all(lote.map(async (item) => {
              const itemId = `${item.link}-${item.pubDate}`;
              const idioma = TranslationService.getIdiomaFuente(item.source);

              // Solo traducir si no est√° ya en cache
              if (!traducciones[itemId]) {
                setCargandoTraduccion(prev => ({ ...prev, [itemId]: true }));

                try {
                  const [tituloTraducido, descTraducida] = await Promise.all([
                    TranslationService.traducir(item.title, idioma, 'es'),
                    TranslationService.traducir(item.description?.replace(/<[^>]+>/g, ''), idioma, 'es')
                  ]);

                  if (tituloTraducido || descTraducida) {
                    setTraducciones(prev => ({
                      ...prev,
                      [itemId]: {
                        title: tituloTraducido || item.title,
                        description: descTraducida || item.description
                      }
                    }));
                  }
                } catch (error) {
                  console.error('Error traduciendo:', error);
                } finally {
                  setCargandoTraduccion(prev => ({ ...prev, [itemId]: false }));
                  setTraduciendoCount(prev => prev + 1);
                }
              }
            }));
          }
        };

        traducirAutomaticamente();
      }, [news]);

      const newsClasificadas = news.map(item => ({
        ...item,
        clasificacion: ClasificadorNoticias.clasificar(item)
      }));

      const newsOrdenadas = [...newsClasificadas].sort((a, b) => {
        if (ordenPorPuntuacion) {
          return b.clasificacion.puntuacion - a.clasificacion.puntuacion;
        } else {
          return new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime();
        }
      });

      // Filtrar por b√∫squeda
      const newsConBusqueda = busqueda.trim()
        ? newsOrdenadas.filter(item => {
          const busquedaLower = busqueda.toLowerCase();
          return item.title.toLowerCase().includes(busquedaLower) ||
            item.description.toLowerCase().includes(busquedaLower) ||
            item.source.toLowerCase().includes(busquedaLower);
        })
        : newsOrdenadas;

      // Filtrar por categor√≠a (solo en modo puntaje)
      const newsFiltradas = ordenPorPuntuacion
        ? (filtroActivo === 'TODOS' ? newsConBusqueda : newsConBusqueda.filter(n => n.clasificacion.etiqueta === filtroActivo))
        : newsConBusqueda;

      const conteos = {
        TODOS: newsClasificadas.length,
        URGENTE: newsClasificadas.filter(n => n.clasificacion.etiqueta === 'URGENTE').length,
        CLAVE: newsClasificadas.filter(n => n.clasificacion.etiqueta === 'CLAVE').length,
        IMPORTANTE: newsClasificadas.filter(n => n.clasificacion.etiqueta === 'IMPORTANTE').length,
        RELLENO: newsClasificadas.filter(n => n.clasificacion.etiqueta === 'RELLENO').length,
        BASURA: newsClasificadas.filter(n => n.clasificacion.etiqueta === 'BASURA').length
      };

      const timeAgo = (dateStr) => {
        const date = new Date(dateStr);
        const now = new Date();
        const seconds = Math.floor((now.getTime() - date.getTime()) / 1000);
        if (seconds < 60) return 'Hace un momento';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `Hace ${minutes} min`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `Hace ${hours} h`;
        const days = Math.floor(hours / 24);
        if (days === 1) return 'Ayer';
        if (days < 7) return `Hace ${days} d√≠as`;
        return date.toLocaleDateString('es-AR');
      };

      const getBgColor = (etiqueta) => {
        switch (etiqueta) {
          case 'URGENTE': return 'border-l-4 border-l-red-600 bg-red-950/20';
          case 'CLAVE': return 'border-l-4 border-l-orange-500 bg-orange-950/20';
          case 'IMPORTANTE': return 'border-l-4 border-l-yellow-500 bg-yellow-950/10';
          case 'RELLENO': return 'border-l-4 border-l-neutral-500 opacity-60';
          case 'BASURA': return 'border-l-4 border-l-neutral-700 opacity-40';
          default: return '';
        }
      };

      const traducionEstado = TranslationService.getEstado();
      const hayNoticasParaTraducir = news.some(item => TranslationService.necesitaTraduccion(item.source));

      return (
        <div className="bg-neutral-900 border border-neutral-800 min-h-[500px] relative shadow-2xl">
          {selectedNews && (() => {
            const itemId = `${selectedNews.link}-${selectedNews.pubDate}`;
            const traduccion = traducciones[itemId];
            const verOriginal = mostrarOriginal[itemId];
            const mostrarTrad = traduccion && !verOriginal;
            const idioma = TranslationService.getIdiomaFuente(selectedNews.source);
            const necesitaTrad = TranslationService.necesitaTraduccion(selectedNews.source);
            const nombreIdioma = TranslationService.NOMBRES_IDIOMAS[idioma] || idioma;

            const modalTitle = mostrarTrad ? traduccion.title : selectedNews.title;
            const modalDesc = mostrarTrad ? traduccion.description : selectedNews.description;

            return (
              <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 fade-in" onClick={() => setSelectedNews(null)}>
                <div className="bg-neutral-900 border border-neutral-700 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl relative slide-up" onClick={(e) => e.stopPropagation()}>
                  <div className="p-6 border-b border-neutral-800 flex justify-between items-start sticky top-0 bg-neutral-900/95 backdrop-blur z-10">
                    <div className="flex-1 pr-4">
                      <div className="flex items-center gap-2 mb-2">
                        <ClasificacionBadge clasificacion={selectedNews.clasificacion} showDetails={true} />
                      </div>
                      <span className="inline-block px-2 py-0.5 bg-neutral-800 text-neutral-300 border border-neutral-700 text-[10px] font-black uppercase tracking-wider mb-2">
                        {selectedNews.source}
                      </span>
                      {necesitaTrad && (
                        <div className="mb-2">
                          {mostrarTrad ? (
                            <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-900/30 text-green-400 text-[9px] font-bold uppercase rounded border border-green-900/50">
                              <Languages className="w-3 h-3" /> Traducido del {nombreIdioma}
                            </span>
                          ) : (
                            <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-blue-900/30 text-blue-400 text-[9px] font-bold uppercase rounded border border-blue-900/50">
                              <Globe className="w-3 h-3" /> Original en {nombreIdioma}
                            </span>
                          )}
                        </div>
                      )}
                      <h2 className="text-xl md:text-2xl font-black text-white leading-tight">{modalTitle}</h2>
                      <div className="flex items-center gap-2 mt-2 text-xs text-neutral-500 font-mono">
                        <Clock className="w-3 h-3" /> {selectedNews.pubDate}
                      </div>
                    </div>
                    <button onClick={() => setSelectedNews(null)} className="text-neutral-500 hover:text-white p-2 shrink-0">
                      <X className="w-6 h-6" />
                    </button>
                  </div>
                  <div className="p-4 bg-neutral-950 border-b border-neutral-800">
                    <h4 className="text-[10px] font-bold text-neutral-500 uppercase tracking-wider mb-2">An√°lisis</h4>
                    <p className="text-sm text-neutral-300 mb-2">{selectedNews.clasificacion.justificacion}</p>
                    {selectedNews.clasificacion.indicadores.length > 0 && (
                      <div className="flex flex-wrap gap-1 mt-2">
                        {selectedNews.clasificacion.indicadores.slice(0, 6).map((ind, i) => (
                          <span key={i} className="px-2 py-0.5 bg-neutral-800 text-neutral-400 text-[9px] font-mono rounded">{ind}</span>
                        ))}
                      </div>
                    )}
                  </div>
                  <div className="p-6 space-y-4">
                    <div className="text-neutral-300 font-medium text-lg leading-relaxed border-l-4 border-red-600 pl-4 italic">
                      {modalDesc}
                    </div>
                    <div className="text-neutral-400 text-sm leading-relaxed space-y-4 font-serif">
                      {selectedNews.content && selectedNews.content !== selectedNews.description ? (
                        <div dangerouslySetInnerHTML={{ __html: selectedNews.content }} className="prose prose-invert prose-sm max-w-none" />
                      ) : (
                        <p>Para leer el desarrollo completo de la noticia, visite la fuente original.</p>
                      )}
                    </div>
                  </div>
                  {necesitaTrad && traduccion && (
                    <div className="px-6 py-3 bg-neutral-950 border-t border-neutral-800">
                      <button
                        onClick={() => setMostrarOriginal(prev => ({ ...prev, [itemId]: !prev[itemId] }))}
                        className="text-[10px] text-neutral-400 hover:text-white underline"
                      >
                        {mostrarTrad ? `Ver original en ${nombreIdioma}` : 'Ver traducci√≥n al espa√±ol'}
                      </button>
                    </div>
                  )}
                  <div className="p-6 border-t border-neutral-800 bg-neutral-950">
                    <a href={selectedNews.link} target="_blank" rel="noreferrer" className="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-3 uppercase tracking-wider text-sm flex items-center justify-center gap-2 transition-colors">
                      Leer en Fuente Original <ExternalLink className="w-4 h-4" />
                    </a>
                  </div>
                </div>
              </div>
            );
          })()}

          <div className="bg-neutral-950 p-4 border-b border-neutral-800">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-3">
              <div className="flex items-center gap-3">
                {hayNoticasParaTraducir && traduciendoCount < totalParaTraducir && (
                  <span className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-900/30 text-blue-400 text-[10px] font-bold uppercase rounded border border-blue-800">
                    <Loader2 className="w-3.5 h-3.5 animate-spin" /> Traduciendo... ({traduciendoCount}/{totalParaTraducir})
                  </span>
                )}
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setOrdenPorPuntuacion(!ordenPorPuntuacion)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 text-[10px] font-bold uppercase rounded border transition-all ${ordenPorPuntuacion
                    ? 'bg-orange-900/30 text-orange-400 border-orange-800'
                    : 'bg-neutral-800 text-neutral-400 border-neutral-700 hover:bg-neutral-700'
                    }`}
                  title={ordenPorPuntuacion ? "Cambiar a vista cronol√≥gica" : "Cambiar a vista por puntaje"}
                >
                  {ordenPorPuntuacion ? <CalendarIcon className="w-3.5 h-3.5" /> : <Key className="w-3.5 h-3.5" />}
                  {ordenPorPuntuacion ? "Cronol√≥gico" : "Puntaje"}
                </button>
                <button onClick={onRefresh} disabled={loading} className="text-neutral-500 hover:text-white transition-colors">
                  <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
                </button>
              </div>
            </div>

            {/* Input de b√∫squeda */}
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500" />
              <input
                type="text"
                value={busqueda}
                onChange={(e) => setBusqueda(e.target.value)}
                placeholder={ordenPorPuntuacion ? "Filtrar por palabras clave..." : "Buscar en cronol√≥gico..."}
                className="w-full bg-neutral-900 border border-neutral-800 text-white text-sm px-10 py-2 pl-10 focus:outline-none focus:border-red-600 placeholder:text-neutral-600 font-mono"
              />
              {busqueda && (
                <button
                  onClick={() => setBusqueda('')}
                  className="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-500 hover:text-white transition-colors"
                >
                  <X className="w-4 h-4" />
                </button>
              )}
            </div>

            {/* Contador de resultados de b√∫squeda */}
            {busqueda && (
              <div className="text-[10px] text-neutral-500 font-mono mt-2">
                {newsFiltradas.length} {newsFiltradas.length === 1 ? 'resultado' : 'resultados'} para "{busqueda}"
              </div>
            )}
            {hayNoticasParaTraducir && (
              <div className="flex items-center gap-2 mt-2 text-[9px] text-neutral-500">
                <Languages className="w-3 h-3" />
                <span>Traducci√≥n: MyMemory ({traducionEstado.usadas}/{traducionEstado.maximo}) + Lingva con CORS proxy (ilimitado)</span>
              </div>
            )}
          </div>

          {ordenPorPuntuacion && !loading && !error && news.length > 0 && (
            <FiltrosClasificacion filtroActivo={filtroActivo} onFiltrar={setFiltroActivo} conteos={conteos} />
          )}

          <div className="p-0">
            {loading && (
              <div className="p-12 text-center text-neutral-500 font-mono animate-pulse flex flex-col items-center gap-4">
                <RefreshCw className="w-8 h-8 animate-spin text-red-600" />
                RECUPERANDO Y CLASIFICANDO CABLES...
              </div>
            )}
            {!loading && error && (
              <div className="p-8 text-center">
                <p className="text-red-500 font-bold mb-2">ERROR DE CONEXI√ìN</p>
                <p className="text-neutral-500 text-sm mb-4">No se pudo conectar con los feeds RSS.</p>
              </div>
            )}
            {!loading && !error && (
              <div className="divide-y divide-neutral-800">
                {newsFiltradas.map((item, idx) => {
                  const itemId = `${item.link}-${item.pubDate}`;
                  const traduccion = traducciones[itemId];
                  const verOriginal = mostrarOriginal[itemId];
                  const mostrarTrad = traduccion && !verOriginal;

                  const displayTitle = mostrarTrad ? traduccion.title : item.title;
                  const displayDesc = mostrarTrad ? traduccion.description : item.description;
                  const sourceCountry = getCountryBySource(item.source);

                  // En modo cronol√≥gico, estilo simplificado sin colores de clasificaci√≥n
                  const esModoCronologico = !ordenPorPuntuacion;

                  return (
                    <div key={idx} className={`p-5 hover:bg-neutral-800/50 transition-colors group cursor-pointer ${esModoCronologico ? '' : getBgColor(item.clasificacion.etiqueta)}`} onClick={() => setSelectedNews(item)}>
                      <div className="flex flex-wrap justify-between items-start gap-2 mb-2">
                        <div className="flex items-center gap-2 flex-wrap">
                          {!esModoCronologico && <ClasificacionBadge clasificacion={item.clasificacion} />}
                          {/* BANDERA JUNTO AL NOMBRE DEL MEDIO */}
                          <div className="flex items-center gap-2">
                            {sourceCountry && getFlag(sourceCountry)}
                            <span className="inline-block px-2 py-0.5 bg-neutral-800 text-neutral-400 border border-neutral-700 text-[10px] font-black uppercase tracking-wider">
                              {item.source}
                            </span>
                          </div>
                        </div>
                        <span className="text-neutral-500 text-[10px] font-bold uppercase flex items-center gap-1">
                          <Clock className="w-3 h-3" /> {timeAgo(item.pubDate)}
                        </span>
                      </div>

                      <TranslationToggle
                        item={item}
                        traduccion={traduccion}
                        cargando={cargandoTraduccion[itemId]}
                        onAlternar={(itemId) => setMostrarOriginal(prev => ({ ...prev, [itemId]: !prev[itemId] }))}
                        mostrarOriginal={verOriginal}
                      />

                      <h4 className={`font-bold text-lg leading-tight mb-2 px-3 py-2 transition-colors ${esModoCronologico ? 'bg-neutral-800 text-white group-hover:bg-neutral-700' : (item.clasificacion.etiqueta === 'BASURA' || item.clasificacion.etiqueta === 'RELLENO' ? 'bg-neutral-800 text-neutral-400' : 'bg-white text-red-600 group-hover:bg-red-50')}`}>
                        {displayTitle}
                      </h4>

                      <p className="text-neutral-400 text-sm leading-relaxed line-clamp-2 mb-2">
                        {displayDesc}
                      </p>

                      {!esModoCronologico && item.clasificacion.indicadores.length > 0 && item.clasificacion.etiqueta !== 'BASURA' && item.clasificacion.etiqueta !== 'RELLENO' && (
                        <div className="flex flex-wrap gap-1 mb-2">
                          {item.clasificacion.indicadores.slice(0, 3).map((ind, i) => (
                            <span key={i} className="px-1.5 py-0.5 bg-neutral-800/50 text-neutral-500 text-[9px] font-mono">{ind}</span>
                          ))}
                        </div>
                      )}

                      <span className="inline-flex items-center gap-1 text-xs font-bold text-neutral-500 hover:text-white uppercase tracking-wider">
                        <FileText className="w-3 h-3" /> Ver Detalle
                      </span>
                    </div>
                  );
                })}
                {newsFiltradas.length === 0 && !loading && (
                  <div className="p-8 text-center text-neutral-600 italic">No hay cables con esta clasificaci√≥n.</div>
                )}
              </div>
            )}
          </div>

          {ordenPorPuntuacion && (
            <div className="bg-neutral-950 p-4 border-t border-neutral-800">
              <h4 className="text-xs font-bold text-neutral-500 uppercase tracking-widest mb-3">Estad√≠sticas de Clasificaci√≥n</h4>
              <div className="flex flex-wrap gap-4 text-[10px] font-mono text-neutral-500">
                <span>üî¥ Urgentes: {conteos.URGENTE}</span>
                <span>üü† Claves: {conteos.CLAVE}</span>
                <span>üü° Importantes: {conteos.IMPORTANTE}</span>
                <span>‚ö™ Relleno: {conteos.RELLENO}</span>
                <span>‚ö´ Basura: {conteos.BASURA}</span>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PANEL DE PROTESTAS - ESTILO COMO SOURCESSIDEBAR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const ProtestPanel = ({ isOpen, onToggle }) => {
      const [activeTab, setActiveTab] = useState('hoy');
      const [protestas, setProtestas] = useState({ ayer: [], hoy: [], manana: [] });
      const [loading, setLoading] = useState(true);
      const [lastUpdated, setLastUpdated] = useState(null);
      const [isFullscreen, setIsFullscreen] = useState(false);

      // Funci√≥n para obtener strings de fecha (igual que script.js original)
      const getDateStrings = () => {
        const now = new Date();
        const today = new Date(now.toLocaleString('en-US', { timeZone: 'America/Argentina/Buenos_Aires' }));
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const toYYYYMMDD = (d) => d.toISOString().split('T')[0];
        return { ayer: toYYYYMMDD(yesterday), hoy: toYYYYMMDD(today), manana: toYYYYMMDD(tomorrow) };
      };

      // Funci√≥n para calcular el estado de la protesta (igual l√≥gica que script.js)
      const calculateStatus = (event) => {
        const now = new Date();
        const [year, month, day] = (event.fecha || '1970-01-01').split('-');
        const [hour, minute] = (event.horario || '00:00').split(':');

        // Manejar casos especiales de horario
        let parsedHour = parseInt(hour) || 0;
        let parsedMinute = parseInt(minute) || 0;

        // Si el horario tiene formato especial (como **11:00**), extraer solo los n√∫meros
        if (event.horario && event.horario.includes('**')) {
          const match = event.horario.match(/\*\*(\d{1,2}):(\d{2})\*\*/);
          if (match) {
            parsedHour = parseInt(match[1]);
            parsedMinute = parseInt(match[2]);
          }
        }

        // Si el horario es explicaci√≥n textual, usar 09:00 como default
        if (isNaN(parsedHour)) {
          parsedHour = 9;
          parsedMinute = 0;
        }

        const eventDate = new Date(Date.UTC(year, month - 1, day, parsedHour, parsedMinute));
        const eventEndDate = new Date(eventDate.getTime() + 4 * 60 * 60 * 1000); // +4 horas de duraci√≥n

        if (now > eventEndDate) {
          return { text: 'Finalizada', class: 'status-finalizada' };
        } else if (now >= eventDate && now <= eventEndDate) {
          return { text: 'En desarrollo', class: 'status-en-desarrollo' };
        } else {
          return { text: 'Programada', class: 'status-programada' };
        }
      };

      // Cargar datos reales del JSON
      const fetchProtests = async () => {
        setLoading(true);
        try {
          const response = await fetch('https://raw.githubusercontent.com/CarlosDimare/PROTESTA/refs/heads/main/protests.json?cachebust=' + new Date().getTime());
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();

          setLastUpdated(data.last_updated);

          const dates = getDateStrings();
          const categorizedEvents = {
            ayer: data.events.filter(e => e.fecha === dates.ayer && e.es_evento_relevante),
            hoy: data.events.filter(e => e.fecha === dates.hoy && e.es_evento_relevante),
            manana: data.events.filter(e => e.fecha === dates.manana && e.es_evento_relevante)
          };

          // Ordenar eventos por horario
          Object.keys(categorizedEvents).forEach(key => {
            categorizedEvents[key].sort((a, b) => (a.horario || '99:99').localeCompare(b.horario || '99:99'));
          });

          setProtestas(categorizedEvents);
        } catch (error) {
          console.error("Error al cargar los datos de protestas:", error);
          // En caso de error, mantener arrays vac√≠os
          setProtestas({ ayer: [], hoy: [], manana: [] });
        } finally {
          setLoading(false);
        }
      };

      // Cargar datos al montar el componente
      useEffect(() => {
        fetchProtests();
        // Recargar cada 30 minutos
        const interval = setInterval(fetchProtests, 30 * 60 * 1000);
        return () => clearInterval(interval);
      }, []);

      const tabs = ['ayer', 'hoy', 'manana'];

      const getEstadoColor = (statusClass) => {
        switch (statusClass) {
          case 'status-en-desarrollo': return 'text-red-400 font-bold';
          case 'status-programada': return 'text-yellow-400 font-medium';
          case 'status-finalizada': return 'text-neutral-500 italic';
          default: return 'text-neutral-400';
        }
      };

      // Ya no se usa renderFuenteCell porque eliminamos la columna Fuente

      return (
        <>
          {/* Overlay para mobile */}
          {isOpen && <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-30 md:hidden fade-in" onClick={onToggle} />}

          {/* Panel ocultable */}
          <aside className={`fixed right-0 top-16 bottom-0 z-40 bg-neutral-900 border-l border-neutral-800 flex flex-col sidebar-transition ${isFullscreen ? 'left-0 right-0 w-full' : 'w-[400px]'} ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}>
            <div className="flex flex-col h-full">
              <div className="p-4 border-b border-neutral-800 flex justify-between items-center bg-neutral-950">
                <h3 className="text-lg font-black text-white uppercase tracking-wider flex items-center gap-2">
                  <Users className="w-6 h-6 text-red-500" /> Protestas
                </h3>
                <div className="flex items-center gap-1">
                  {!isFullscreen && isOpen && (
                    <button
                      onClick={() => setIsFullscreen(true)}
                      className="text-neutral-500 hover:text-red-500 p-1 hover:bg-neutral-800 rounded transition-colors"
                      title="Maximizar pantalla completa"
                    >
                      <Maximize2 className="w-5 h-5" />
                    </button>
                  )}
                  {isFullscreen && (
                    <button
                      onClick={() => setIsFullscreen(false)}
                      className="text-neutral-500 hover:text-white p-1 hover:bg-neutral-800 rounded transition-colors"
                      title="Salir de pantalla completa"
                    >
                      <Minimize2 className="w-5 h-5" />
                    </button>
                  )}
                  <button onClick={onToggle} className="text-neutral-500 hover:text-white p-1 hover:bg-neutral-800 rounded transition-colors">
                    <X className="w-6 h-6" />
                  </button>
                </div>
              </div>

              {/* Navegaci√≥n por pesta√±as estilo SourcesSidebar */}
              <div className="p-3 border-b border-neutral-800 bg-neutral-950/50">
                <div className="flex">
                  {tabs.map(tab => {
                    const labels = { ayer: 'Ayer', hoy: 'Hoy', manana: 'Ma√±ana' };
                    const count = protestas[tab]?.length || 0;
                    return (
                      <button
                        key={tab}
                        onClick={() => setActiveTab(tab)}
                        className={`flex-1 text-[10px] text-neutral-400 hover:text-white uppercase font-bold py-2 px-3 rounded transition-all flex items-center justify-center gap-2 ${activeTab === tab
                          ? 'bg-red-900/20 border border-red-800/50 text-red-100'
                          : 'bg-neutral-800/50 border border-neutral-700/50 hover:bg-neutral-700 hover:text-neutral-300'
                          }`}
                      >
                        {labels[tab]} ({count})
                      </button>
                    );
                  })}
                </div>
              </div>

              {/* Contenido con scrollbar personalizado */}
              {loading ? (
                <div className="flex-1 flex items-center justify-center sidebar-scroll p-4">
                  <div className="text-center text-neutral-500">
                    <RefreshCw className="w-12 h-12 animate-spin mx-auto mb-2 text-red-500" />
                    <p className="text-xl">Cargando protestas...</p>
                  </div>
                </div>
              ) : (
                <div className="flex-1 overflow-y-auto sidebar-scroll">
                  <div className="p-3">
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-neutral-950 border-b border-neutral-800">
                          <tr>
                            <th className="px-3 py-3 text-left font-black uppercase tracking-wider text-neutral-400 whitespace-nowrap text-[8px]">Hora</th>
                            <th className="px-3 py-3 text-left font-black uppercase tracking-wider text-neutral-400 whitespace-nowrap text-[8px]">Qu√©</th>
                            <th className="px-3 py-3 text-left font-black uppercase tracking-wider text-neutral-400 whitespace-nowrap text-[8px]">Qui√©n</th>
                            <th className="px-3 py-3 text-left font-black uppercase tracking-wider text-neutral-400 whitespace-nowrap text-[8px]">D√≥nde</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-neutral-800">
                          {protestas[activeTab]?.length > 0 ? (
                            protestas[activeTab].map((protesta, index) => {
                              const status = calculateStatus(protesta);
                              return (
                                <tr key={index} className="hover:bg-neutral-800/30 transition-colors">
                                  <td className="px-3 py-3 text-neutral-300 font-mono whitespace-nowrap text-[12px]">
                                    {protesta.horario === 'No especificado' ? 'N/A' : protesta.horario}
                                  </td>
                                  <td className="px-3 py-3 text-neutral-200 font-medium text-[12px]">
                                    {protesta.tipo_medida}
                                  </td>
                                  <td className="px-3 py-3 text-neutral-300" title={protesta.quien}>
                                    {protesta.quien === 'No especificado' ? 'N/A' : protesta.quien}
                                  </td>
                                  <td className="px-3 py-3 text-neutral-400" title={protesta.lugar}>
                                    {protesta.lugar === 'No especificado' ? 'N/A' : protesta.lugar}
                                  </td>
                                </tr>
                              );
                            })
                          ) : (
                            <tr>
                              <td colSpan="4" className="px-6 py-8 text-center text-neutral-500 text-[12px] italic">
                                No se encontraron protestas para {activeTab}
                              </td>
                            </tr>
                          )}
                        </tbody>
                      </table>
                    </div>

                    {/* √öltima actualizaci√≥n movida debajo de la tabla */}
                    {lastUpdated && (
                      <div className="text-[12px] text-neutral-500 font-mono mt-4 mb-2 uppercase tracking-wider border-t border-neutral-800 pt-2">
                        √öltima actualizaci√≥n: {new Date(lastUpdated).toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' })}
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </aside>
        </>
      );
    };

    const ConflictMonitorPanel = ({ isOpen, onToggle }) => {
      const monitorHtml = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè≠ Monitor de Conflictos</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"><\/script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            background: #0d1117;
            color: #c9d1d9;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .scrollbar-dark::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-dark::-webkit-scrollbar-track {
            background: #161b22;
        }
        .scrollbar-dark::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 3px;
        }
        .scrollbar-dark::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
        .item-hover {
            transition: all 0.15s ease;
        }
        .item-hover:hover {
            background: #161b22;
        }
        .conflict-item.active {
            background: #1f2937;
            border-left: 4px solid #f78166;
        }
        .feed-item.active {
            background: #1f2937;
            border-left: 4px solid #58a6ff;
        }
        .feed-item.processed {
            opacity: 0.5;
        }
        .feed-item.is-conflict {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
        }
        .feed-item.not-conflict {
            border-left: 3px solid #30363d;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .slide-in {
            animation: slideIn 0.2s ease;
        }
        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 9999px;
        }
        .progress-bar-container {
            height: 3px;
            background: #21262d;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #a371f7, #58a6ff);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            transition: width 0.3s ease;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .analysis-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 6px;
            font-size: 12px;
        }
        .analysis-indicator.hidden {
            display: none;
        }
        .resumen-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .resumen-label {
            color: #8b949e;
            min-width: 70px;
            font-weight: 500;
        }
        .resumen-value {
            color: #c9d1d9;
            flex: 1;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-[#161b22] border-b border-[#30363d]">
        <div class="px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üè≠</span>
                <h1 class="text-[#58a6ff] font-bold text-lg">MONITOR DE CONFLICTOS</h1>
                <span class="text-xs text-white bg-blue-600 px-2 py-1 rounded font-medium">üá¶üá∑ Argentina</span>
            </div>
            <div class="flex items-center gap-4">
                <!-- Indicador de an√°lisis en progreso -->
                <div id="analysis-indicator" class="analysis-indicator hidden">
                    <div class="spinner w-4 h-4 border-2 border-[#30363d] border-t-[#58a6ff] rounded-full"></div>
                    <span id="analysis-status" class="text-[#58a6ff]">Analizando...</span>
                    <span id="analysis-count" class="text-[#8b949e]">0/0</span>
                </div>
                <div class="flex items-center gap-2 text-xs text-[#8b949e]">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full"></span> Conflicto</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 bg-gray-500 rounded-full"></span> Descartado</span>
                </div>
                <span id="clock" class="text-[#8b949e] text-sm font-mono"></span>
                <button onclick="recargar()" id="reload-btn" class="bg-[#238636] hover:bg-[#2ea043] text-white px-3 py-1.5 rounded text-sm font-medium flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg id="reload-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Recargar
                </button>
            </div>
        </div>
        <!-- Barra de progreso sutil -->
        <div id="progress-container" class="progress-bar-container hidden">
            <div id="progress-bar" class="progress-bar-fill" style="width: 0%"></div>
        </div>
    </header>

    <!-- Main Content - 3 Columnas -->
    <main class="flex-1 flex overflow-hidden">
        <!-- Panel 1 - Feed Crudo -->
        <div class="w-[30%] border-r border-[#30363d] flex flex-col">
            <div class="bg-[#161b22] border-b border-[#30363d] px-3 py-2 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-[#8b949e]">üì•</span>
                    <span class="text-[#8b949e] font-bold text-sm">FEED RSS CRUDO</span>
                </div>
                <span id="feed-count" class="text-xs bg-[#21262d] text-[#8b949e] px-2 py-0.5 rounded-full">0</span>
            </div>
            <div class="bg-[#0d1117] border-b border-[#30363d] px-3 py-1.5 flex gap-2 text-xs">
                <span id="stat-total" class="text-[#8b949e]">Total: 0</span>
                <span class="text-[#30363d]">|</span>
                <span id="stat-conflicts" class="text-green-500">Conflictos: 0</span>
                <span class="text-[#30363d]">|</span>
                <span id="stat-discarded" class="text-gray-500">Descartados: 0</span>
                <span class="text-[#30363d]">|</span>
                <span id="stat-pending" class="text-yellow-500">Pendientes: 0</span>
            </div>
            <div id="lista-feed" class="flex-1 overflow-y-auto scrollbar-dark">
                <div class="text-center text-[#8b949e] py-10">
                    <span class="text-2xl">üì°</span>
                    <p class="mt-2 text-sm">Esperando carga...</p>
                </div>
            </div>
        </div>

        <!-- Panel 2 - Conflictos Detectados -->
        <div class="w-[30%] border-r border-[#30363d] flex flex-col">
            <div class="bg-[#161b22] border-b border-[#30363d] px-3 py-2 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-[#f78166]">‚ö†Ô∏è</span>
                    <span class="text-[#f78166] font-bold text-sm">CONFLICTOS DETECTADOS</span>
                </div>
                <span id="conflict-count" class="text-xs bg-red-500/20 text-red-400 px-2 py-0.5 rounded-full">0</span>
            </div>
            <div class="bg-[#0d1117] border-b border-[#30363d] px-3 py-1.5 flex gap-2 text-xs">
                <span class="text-[#8b949e]">Agrupados por empresa</span>
                <span class="text-[#30363d]">|</span>
                <span id="conflict-status" class="text-[#8b949e]">Orden alfab√©tico</span>
            </div>
            <div id="lista-conflictos" class="flex-1 overflow-y-auto scrollbar-dark">
                <div class="text-center text-[#8b949e] py-10">
                    <span class="text-2xl">üîç</span>
                    <p class="mt-2 text-sm">Esperando an√°lisis...</p>
                </div>
            </div>
        </div>

        <!-- Panel 3 - Detalle -->
        <div class="w-[40%] flex flex-col">
            <div class="bg-[#161b22] border-b border-[#30363d] px-3 py-2 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-[#58a6ff]">üìã</span>
                    <span class="text-[#58a6ff] font-bold text-sm">DETALLE DEL CONFLICTO</span>
                </div>
                <span id="ia-badge" class="text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full flex items-center gap-1">
                    <span class="w-1.5 h-1.5 bg-purple-400 rounded-full"></span>
                    
                </span>
            </div>
            <div id="detalle-panel" class="flex-1 overflow-y-auto scrollbar-dark p-4">
                <div class="text-center text-[#8b949e] mt-16">
                    <span class="text-4xl">üëÜ</span>
                    <p class="mt-4">Selecciona un conflicto o noticia</p>
                    <p class="text-xs mt-2">para ver el resumen detallado</p>
                    <p class="text-xs mt-4 text-[#6e7681]">El an√°lisis contin√∫a en segundo plano</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-[#161b22] border-t border-[#30363d] px-4 py-2 flex justify-between text-xs text-[#8b949e]">
        <div class="flex gap-6">
            <span><kbd class="bg-[#21262d] px-1.5 py-0.5 rounded">R</kbd> Recargar</span>
            <span><kbd class="bg-[#21262d] px-1.5 py-0.5 rounded">‚Üë‚Üì</kbd> Navegar</span>
            <span><kbd class="bg-[#21262d] px-1.5 py-0.5 rounded">Enter</kbd> Abrir noticia</span>
            <span><kbd class="bg-[#21262d] px-1.5 py-0.5 rounded">1-2</kbd> Cambiar panel</span>
        </div>
        <div id="status" class="flex items-center gap-2">
            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
            <span>Listo</span>
        </div>
    </footer>

    <script>
        // === CONFIGURACI√ìN ===
        const POLLINATIONS_URL = "https://text.pollinations.ai/";
        const CORS_PROXY = "https://api.allorigins.win/raw?url=";
        
        // Feeds ampliados para capturar m√°s conflictos
        const FUENTES_RSS = [
            {
                url: "https://news.google.com/rss/search?q=(despidos+OR+suspensiones+OR+cierre+OR+conciliacion+obligatoria)+Argentina+when:3d&hl=es-419&gl=AR&ceid=AR:es-419",
                nombre: "Despidos y cierres"
            },
            {
                url: "https://news.google.com/rss/search?q=(paro+OR+huelga+OR+bloqueo+OR+piquete+OR+corte)+trabajadores+Argentina+when:3d&hl=es-419&gl=AR&ceid=AR:es-419",
                nombre: "Paros y bloqueos"
            },
            {
                url: "https://news.google.com/rss/search?q=(conflicto+laboral+OR+protesta+trabajadores+OR+reclamo+salarial)+Argentina+when:3d&hl=es-419&gl=AR&ceid=AR:es-419",
                nombre: "Conflictos laborales"
            },
            {
                url: "https://news.google.com/rss/search?q=(gremio+OR+sindicato+OR+CGT+OR+CTA)+(reclama+OR+denuncia+OR+moviliza)+Argentina+when:3d&hl=es-419&gl=AR&ceid=AR:es-419",
                nombre: "Acciones sindicales"
            },
            {
                url: "https://news.google.com/rss/search?q=(paritarias+OR+aumento+salarial+OR+bono)+(rechazo+OR+conflicto+OR+tension)+Argentina+when:3d&hl=es-419&gl=AR&ceid=AR:es-419",
                nombre: "Paritarias"
            },
        ];

        // Provincias y ciudades argentinas para validaci√≥n
        const UBICACIONES_ARGENTINA = [
            'buenos aires', 'caba', 'c√≥rdoba', 'cordoba', 'rosario', 'mendoza', 'tucum√°n', 'tucuman',
            'la plata', 'mar del plata', 'salta', 'santa fe', 'san juan', 'resistencia', 'neuqu√©n', 'neuquen',
            'formosa', 'posadas', 'san luis', 'santiago del estero', 'corrientes', 'bah√≠a blanca', 'bahia blanca',
            'paran√°', 'parana', 'san miguel de tucum√°n', 'comodoro rivadavia', 'rio gallegos', 'ushuaia',
            'rawson', 'viedma', 'la rioja', 'catamarca', 'san salvador de jujuy', 'jujuy', 'chaco',
            'entre r√≠os', 'entre rios', 'misiones', 'chubut', 'santa cruz', 'tierra del fuego', 'r√≠o negro', 'rio negro',
            'la pampa', 'argentina', 'argentino', 'argentina'
        ];

        // Estado global
        let cacheAnalisis = {};
        let feedGlobal = [];
        let conflictosGlobales = [];
        let conflictoSeleccionado = null;
        let feedSeleccionado = null;
        let panelActivo = 2; // 1=feed, 2=conflictos
        let estadisticas = { total: 0, conflictos: 0, descartados: 0, pendientes: 0 };
        let analizando = false;
        let cancelarAnalisis = false;
        let gestorGlobal = null;

        // === UTILIDADES ===
        function md5(string) {
            let hash = 0;
            for (let i = 0; i < string.length; i++) {
                const char = string.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        function actualizarReloj() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('es-AR');
        }
        setInterval(actualizarReloj, 1000);
        actualizarReloj();

        function formatearFecha(fechaStr) {
            if (!fechaStr) return '';
            try {
                const fecha = new Date(fechaStr);
                return fecha.toLocaleDateString('es-AR', { 
                    day: '2-digit', 
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return '';
            }
        }

        // === AN√ÅLISIS CON POLLINATIONS AI ===
        async function analizarConPollinations(titulo, contextoExistente = null) {
            const hashTitulo = md5(titulo + (contextoExistente ? JSON.stringify(contextoExistente) : ''));
            
            if (cacheAnalisis[hashTitulo]) {
                return cacheAnalisis[hashTitulo];
            }

            let prompt;
            
            if (contextoExistente) {
                // Prompt para enriquecer resumen existente
                prompt = \`Tienes un conflicto laboral ya identificado con esta informaci√≥n:
\${JSON.stringify(contextoExistente, null, 2)}

Ahora hay una nueva noticia relacionada:
"\${titulo}"

Genera un resumen MEJORADO y ENRIQUECIDO combinando la informaci√≥n anterior con la nueva. 
Responde SOLO con JSON v√°lido:
{
  "donde": "Ubicaci√≥n m√°s precisa o completa",
  "cuando": "Informaci√≥n temporal m√°s precisa",
  "que_pasa": "Descripci√≥n m√°s completa de la situaci√≥n",
  "protagonistas": "Lista m√°s completa de involucrados",
  "por_que": "Motivos m√°s detallados",
  "evolucion": "C√≥mo ha evolucionado el conflicto si hay nueva informaci√≥n"
}

Responde SOLO el JSON:\`;
            } else {
                // Prompt principal de detecci√≥n - M√ÅS AMPLIO Y FLEXIBLE
                prompt = \`Eres un analista experto en conflictos laborales argentinos. Analiza este titular.
Responde SOLO con JSON v√°lido, sin explicaciones ni markdown.

TITULAR: "\${titulo}"

INSTRUCCIONES DE DETECCI√ìN:
1. ES CONFLICTO LABORAL si menciona CUALQUIERA de estos:
   - Despidos, cesant√≠as, desvinculaciones
   - Suspensiones de personal
   - Cierre de plantas, f√°bricas, locales, sucursales
   - Paros, huelgas, medidas de fuerza
   - Bloqueos, piquetes, cortes, tomas
   - Protestas, movilizaciones, marchas de trabajadores
   - Asambleas, quite de colaboraci√≥n
   - Reclamos salariales, paritarias conflictivas
   - Conciliaci√≥n obligatoria (indica conflicto grave)
   - Denuncias sindicales contra empresas
   - Precarizaci√≥n, trabajo en negro
   - Accidentes laborales graves por negligencia
   - Vaciamiento de empresas, crisis empresarial con afectaci√≥n laboral
   - Quiebras, convocatoria de acreedores con trabajadores afectados
   - Retiros voluntarios masivos (suelen ser encubiertos)

2. ASUMIR ARGENTINA salvo que expl√≠citamente mencione otro pa√≠s (Chile, Uruguay, Brasil, Espa√±a, etc.)

3. IDENTIFICAR ACTOR PRINCIPAL (en orden de prioridad):
   - Nombre exacto de empresa (ej: "Techint", "Ford", "Carrefour")
   - Sector espec√≠fico si no hay empresa (ej: "Sector Aceitero", "Transporte de pasajeros")
   - Actividad/rubro (ej: "Comercio", "Metal√∫rgicos", "Docentes")
   - NUNCA dejar null si hay conflicto real - siempre identificar alg√∫n actor

Formato de respuesta JSON:
{
  "es_conflicto": true/false,
  "es_argentina": true/false,
  "actor_principal": "Empresa espec√≠fica o Sector afectado",
  "tipo_actor": "empresa/sector/gremio/actividad",
  "tipo_conflicto": "despidos/paro/huelga/cierre/suspension/protesta/bloqueo/reclamo/paritarias/otro",
  "donde": "Ciudad, Provincia o 'Argentina' si no especifica",
  "cuando": "Fecha/momento mencionado o 'Actual'",
  "que_pasa": "Descripci√≥n clara y concisa del conflicto",
  "protagonistas": "Qui√©nes: trabajadores, sindicato (cu√°l), empresa, gobierno",
  "por_que": "Causa o motivo del conflicto"
}

IMPORTANTE: S√© INCLUSIVO en la detecci√≥n. Ante la duda, es_conflicto = true.
Los conflictos laborales son noticia porque afectan a trabajadores.

Responde SOLO el JSON:\`;
            }

            try {
                const response = await fetch(POLLINATIONS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: prompt }],
                        model: 'openai'
                    })
                });

                if (!response.ok) {
                    return { es_conflicto: false, es_argentina: false, actor_principal: null, error: \`HTTP \${response.status}\` };
                }

                let texto = await response.text();
                texto = texto.trim().replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();

                if (texto.includes('{')) {
                    const inicio = texto.indexOf('{');
                    const fin = texto.lastIndexOf('}') + 1;
                    texto = texto.substring(inicio, fin);
                }

                const resultado = JSON.parse(texto);
                
                // Compatibilidad: mapear empresa a actor_principal si viene del formato viejo
                if (resultado.empresa && !resultado.actor_principal) {
                    resultado.actor_principal = resultado.empresa;
                    resultado.tipo_actor = 'empresa';
                }
                
                cacheAnalisis[hashTitulo] = resultado;
                return resultado;

            } catch (error) {
                console.error('Error an√°lisis:', error);
                return { es_conflicto: false, es_argentina: false, actor_principal: null, error: error.message };
            }
        }
        
        // Funci√≥n para enriquecer resumen existente
        async function enriquecerResumen(tituloNuevo, resumenExistente) {
            const contexto = {
                donde: resumenExistente.donde,
                cuando: resumenExistente.cuando,
                que_pasa: resumenExistente.que_pasa,
                protagonistas: resumenExistente.protagonistas,
                por_que: resumenExistente.por_que
            };
            
            const mejora = await analizarConPollinations(tituloNuevo, contexto);
            
            if (mejora.error) return resumenExistente;
            
            // Combinar informaci√≥n, priorizando la m√°s detallada
            return {
                donde: (mejora.donde && mejora.donde.length > (resumenExistente.donde || '').length) 
                    ? mejora.donde : resumenExistente.donde,
                cuando: mejora.cuando || resumenExistente.cuando,
                que_pasa: (mejora.que_pasa && mejora.que_pasa.length > (resumenExistente.que_pasa || '').length) 
                    ? mejora.que_pasa : resumenExistente.que_pasa,
                protagonistas: (mejora.protagonistas && mejora.protagonistas.length > (resumenExistente.protagonistas || '').length) 
                    ? mejora.protagonistas : resumenExistente.protagonistas,
                por_que: (mejora.por_que && mejora.por_que.length > (resumenExistente.por_que || '').length) 
                    ? mejora.por_que : resumenExistente.por_que,
                evolucion: mejora.evolucion || resumenExistente.evolucion
            };
        }

        // === GESTOR DE CONFLICTOS ===
        class GestorConflictos {
            constructor() {
                this.conflictos = {};
                this.titulosVistos = new Set();
                this.resumenesConflicto = {}; // Almacena res√∫menes enriquecidos
            }

            async procesarEntrada(entry, index) {
                const titulo = entry.title || '';
                
                const tituloNorm = titulo.toLowerCase().trim();
                if (this.titulosVistos.has(tituloNorm)) {
                    return { agregado: false, mensaje: 'duplicado', analisis: null };
                }
                this.titulosVistos.add(tituloNorm);

                const analisis = await analizarConPollinations(titulo);
                
                // Actualizar item del feed con resultado
                actualizarFeedItem(index, analisis);

                // Verificar que sea conflicto
                if (!analisis.es_conflicto) {
                    return { agregado: false, mensaje: 'no es conflicto', analisis };
                }

                // Verificar Argentina - ser m√°s permisivo
                if (analisis.es_argentina === false) {
                    return { agregado: false, mensaje: 'no es de Argentina', analisis };
                }

                // Obtener actor principal (empresa, sector, o actividad)
                let actor = analisis.actor_principal || analisis.empresa;
                if (!actor) {
                    // √öltimo intento: usar tipo de conflicto como agrupador
                    if (analisis.tipo_conflicto && analisis.protagonistas) {
                        actor = analisis.protagonistas.split(',')[0].trim();
                    }
                    if (!actor) {
                        return { agregado: false, mensaje: 'sin actor identificado', analisis };
                    }
                }

                // Normalizar nombre
                actor = actor.trim().split(' ').map(w => 
                    w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()
                ).join(' ');

                const tituloLimpio = titulo.includes(' - ') 
                    ? titulo.substring(0, titulo.lastIndexOf(' - ')) 
                    : titulo;
                
                // Verificar similitud con noticias existentes
                if (this.conflictos[actor]) {
                    for (const n of this.conflictos[actor]) {
                        if (this.similitud(tituloLimpio, n.titulo) > 0.6) {
                            return { agregado: false, mensaje: 'noticia similar existente', analisis };
                        }
                    }
                }

                const fuente = titulo.includes(' - ') 
                    ? titulo.substring(titulo.lastIndexOf(' - ') + 3) 
                    : 'Fuente';

                // Crear entrada de conflicto
                if (!this.conflictos[actor]) {
                    this.conflictos[actor] = [];
                    // Inicializar resumen con primera noticia
                    this.resumenesConflicto[actor] = {
                        donde: analisis.donde,
                        cuando: analisis.cuando,
                        que_pasa: analisis.que_pasa,
                        protagonistas: analisis.protagonistas,
                        por_que: analisis.por_que,
                        tipo_actor: analisis.tipo_actor || 'empresa',
                        evolucion: null
                    };
                } else {
                    // ENRIQUECER resumen existente con nueva informaci√≥n
                    const resumenActual = this.resumenesConflicto[actor];
                    const resumenMejorado = await enriquecerResumen(tituloLimpio, resumenActual);
                    this.resumenesConflicto[actor] = resumenMejorado;
                }

                this.conflictos[actor].push({
                    titulo: tituloLimpio,
                    link: entry.link || '',
                    fuente: fuente,
                    fecha: entry.pubDate || '',
                    tipo: analisis.tipo_conflicto || analisis.tipo,
                    analisis: analisis,
                    feedIndex: index
                });

                return { agregado: true, mensaje: actor, analisis };
            }

            similitud(a, b) {
                const wa = new Set(a.toLowerCase().split(/\\s+/));
                const wb = new Set(b.toLowerCase().split(/\\s+/));
                if (wa.size === 0 || wb.size === 0) return 0;
                
                const interseccion = new Set([...wa].filter(x => wb.has(x)));
                const union = new Set([...wa, ...wb]);
                return interseccion.size / union.size;
            }

            obtenerOrdenados() {
                const resultado = [];
                for (const [actor, noticias] of Object.entries(this.conflictos)) {
                    resultado.push({ 
                        empresa: actor, 
                        noticias,
                        resumen: this.resumenesConflicto[actor] || {}
                    });
                }
                // Ordenar alfab√©ticamente
                return resultado.sort((a, b) => a.empresa.localeCompare(b.empresa, 'es'));
            }
        }

        // === PARSEAR RSS ===
        async function obtenerRSS(fuente) {
            try {
                const response = await fetch(CORS_PROXY + encodeURIComponent(fuente.url));
                const text = await response.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, 'text/xml');
                
                const items = xml.querySelectorAll('item');
                const entries = [];
                
                items.forEach(item => {
                    entries.push({
                        title: item.querySelector('title')?.textContent || '',
                        link: item.querySelector('link')?.textContent || '',
                        pubDate: item.querySelector('pubDate')?.textContent || '',
                        fuenteRSS: fuente.nombre
                    });
                });
                
                return entries;
            } catch (error) {
                console.error('Error RSS:', error);
                return [];
            }
        }

        // === UI ===
        function mostrarIndicadorAnalisis(show) {
            const indicator = document.getElementById('analysis-indicator');
            const progressContainer = document.getElementById('progress-container');
            
            if (show) {
                indicator.classList.remove('hidden');
                progressContainer.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
                progressContainer.classList.add('hidden');
            }
        }

        function actualizarProgresoAnalisis(actual, total) {
            const progressBar = document.getElementById('progress-bar');
            const analysisCount = document.getElementById('analysis-count');
            const analysisStatus = document.getElementById('analysis-status');
            
            const porcentaje = total > 0 ? (actual / total) * 100 : 0;
            progressBar.style.width = \`\${porcentaje}%\`;
            analysisCount.textContent = \`\${actual}/\${total}\`;
            
            if (actual < total) {
                analysisStatus.textContent = 'Analizando...';
            } else {
                analysisStatus.textContent = '‚úì Completo';
                setTimeout(() => mostrarIndicadorAnalisis(false), 2000);
            }
        }

        function actualizarEstadisticas() {
            document.getElementById('stat-total').textContent = \`Total: \${estadisticas.total}\`;
            document.getElementById('stat-conflicts').textContent = \`Conflictos: \${estadisticas.conflictos}\`;
            document.getElementById('stat-discarded').textContent = \`Descartados: \${estadisticas.descartados}\`;
            document.getElementById('stat-pending').textContent = \`Pendientes: \${estadisticas.pendientes}\`;
        }

        function actualizarStatus(mensaje, tipo = 'normal') {
            const statusEl = document.getElementById('status');
            const colores = {
                normal: 'bg-green-500',
                loading: 'bg-yellow-500',
                error: 'bg-red-500'
            };
            statusEl.innerHTML = \`
                <span class="w-2 h-2 \${colores[tipo]} rounded-full \${tipo === 'loading' ? 'loading-pulse' : ''}"></span>
                <span>\${mensaje}</span>
            \`;
        }

        function renderizarFeed(entries) {
            const lista = document.getElementById('lista-feed');
            const countEl = document.getElementById('feed-count');
            
            feedGlobal = entries;
            countEl.textContent = entries.length;
            estadisticas.total = entries.length;
            estadisticas.pendientes = entries.length;
            actualizarEstadisticas();

            if (entries.length === 0) {
                lista.innerHTML = \`
                    <div class="text-center text-[#8b949e] py-10">
                        <span class="text-2xl">üì≠</span>
                        <p class="mt-2 text-sm">Sin noticias en el feed</p>
                    </div>
                \`;
                return;
            }

            lista.innerHTML = entries.map((e, idx) => {
                const titulo = e.title.includes(' - ') 
                    ? e.title.substring(0, e.title.lastIndexOf(' - ')) 
                    : e.title;
                const fuente = e.title.includes(' - ') 
                    ? e.title.substring(e.title.lastIndexOf(' - ') + 3) 
                    : 'Fuente';
                
                return \`
                    <div class="feed-item item-hover border-b border-[#21262d] p-2 cursor-pointer border-l-4 border-l-[#30363d]" 
                         onclick="seleccionarFeed(\${idx})" data-feed-idx="\${idx}">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                                <div class="text-xs text-[#8b949e] mb-1 flex items-center gap-2">
                                    <span class="badge bg-[#21262d]">\${e.fuenteRSS}</span>
                                    <span>\${fuente}</span>
                                </div>
                                <div class="text-sm text-[#c9d1d9] line-clamp-2">\${titulo}</div>
                            </div>
                            <div id="feed-status-\${idx}" class="flex-shrink-0">
                                <span class="text-[#8b949e] text-xs loading-pulse">‚è≥</span>
                            </div>
                        </div>
                    </div>
                \`;
            }).join('');
        }

        function actualizarFeedItem(index, analisis) {
            const item = document.querySelector(\`[data-feed-idx="\${index}"]\`);
            const statusEl = document.getElementById(\`feed-status-\${index}\`);
            
            if (!item || !statusEl) return;

            estadisticas.pendientes--;

            const actor = analisis.actor_principal || analisis.empresa;
            const esValido = analisis.es_conflicto && actor && analisis.es_argentina !== false;

            if (esValido) {
                item.classList.add('is-conflict');
                item.classList.remove('not-conflict');
                const tipoLabel = analisis.tipo_actor === 'sector' ? 'üì¶' : 
                                  analisis.tipo_actor === 'gremio' ? 'üë•' : 'üè≠';
                statusEl.innerHTML = \`<span class="text-green-500 text-xs">\${tipoLabel} \${actor}</span>\`;
                estadisticas.conflictos++;
            } else {
                item.classList.add('not-conflict', 'processed');
                item.classList.remove('is-conflict');
                let razon = '‚úó';
                if (analisis.es_argentina === false) {
                    razon = '‚úó No ARG';
                } else if (!analisis.es_conflicto) {
                    razon = '‚úó No laboral';
                }
                statusEl.innerHTML = \`<span class="text-gray-500 text-xs">\${razon}</span>\`;
                estadisticas.descartados++;
            }
            
            // Guardar an√°lisis en el objeto global
            feedGlobal[index].analisis = analisis;
            actualizarEstadisticas();

            // Si el usuario est√° viendo este item, actualizar el detalle
            if (feedSeleccionado === index) {
                seleccionarFeed(index);
            }
            
            // Si el usuario est√° viendo un conflicto relacionado, actualizar
            if (conflictoSeleccionado !== null && conflictosGlobales[conflictoSeleccionado]) {
                // Verificar si esta noticia pertenece al conflicto seleccionado
                const conflictoActual = conflictosGlobales[conflictoSeleccionado];
                if (conflictoActual.noticias.some(n => n.feedIndex === index)) {
                    // Re-renderizar para mostrar resumen actualizado
                    setTimeout(() => {
                        if (conflictoSeleccionado !== null) {
                            seleccionarConflicto(conflictoSeleccionado);
                        }
                    }, 100);
                }
            }
        }

        function renderizarConflictos(conflictos, preservarSeleccion = true) {
            const lista = document.getElementById('lista-conflictos');
            const countEl = document.getElementById('conflict-count');
            const statusEl = document.getElementById('conflict-status');
            
            const empresaSeleccionada = preservarSeleccion && conflictoSeleccionado !== null && conflictosGlobales[conflictoSeleccionado] 
                ? conflictosGlobales[conflictoSeleccionado].empresa 
                : null;
            
            conflictosGlobales = conflictos;
            countEl.textContent = conflictos.length;
            
            if (analizando) {
                statusEl.textContent = 'Actualizando...';
            } else {
                statusEl.textContent = 'Orden alfab√©tico A-Z';
            }

            if (conflictos.length === 0) {
                lista.innerHTML = \`
                    <div class="text-center text-[#8b949e] py-10">
                        <span class="text-2xl">üîç</span>
                        <p class="mt-2 text-sm">\${analizando ? 'Buscando conflictos en Argentina...' : 'Sin conflictos detectados'}</p>
                        <p class="text-xs mt-1">\${analizando ? 'Navegue el feed mientras analizamos' : 'Intente recargar'}</p>
                    </div>
                \`;
                return;
            }

            // Encontrar nuevo √≠ndice si hab√≠a selecci√≥n
            let nuevoIdx = null;
            if (empresaSeleccionada) {
                nuevoIdx = conflictos.findIndex(c => c.empresa === empresaSeleccionada);
            }

            lista.innerHTML = conflictos.map((c, idx) => {
                const cant = c.noticias.length;
                const resumen = c.resumen || {};
                const titulo = resumen.que_pasa || c.noticias[0].titulo.substring(0, 60);
                const tipos = [...new Set(c.noticias.map(n => n.tipo).filter(Boolean))];
                const ubicacion = resumen.donde || '';
                const tipoActor = resumen.tipo_actor || 'empresa';
                const isActive = nuevoIdx === idx;
                
                // Icono seg√∫n tipo de actor
                const icono = tipoActor === 'sector' ? 'üì¶' : 
                              tipoActor === 'gremio' ? 'üë•' : 
                              tipoActor === 'actividad' ? '‚öôÔ∏è' : 'üè≠';

                return \`
                    <div class="conflict-item item-hover border-b border-[#21262d] p-3 cursor-pointer border-l-4 border-l-[#f78166] \${isActive ? 'active' : ''}" 
                         onclick="seleccionarConflicto(\${idx})" data-idx="\${idx}">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-white">\${icono}</span>
                            <span class="font-bold text-white uppercase truncate">\${c.empresa}</span>
                            <span class="text-xs text-[#8b949e] bg-[#21262d] px-1.5 py-0.5 rounded">\${cant} fuente\${cant > 1 ? 's' : ''}</span>
                        </div>
                        \${ubicacion ? \`
                        <div class="text-[#58a6ff] text-xs ml-6 mb-1">
                            üìç \${ubicacion}
                        </div>
                        \` : ''}
                        <div class="text-[#8b949e] text-xs ml-6 truncate mb-2">
                            \${titulo.length > 70 ? titulo.substring(0, 70) + '...' : titulo}
                        </div>
                        <div class="flex gap-1 ml-6 flex-wrap">
                            \${tipos.map(t => \`<span class="badge bg-[#21262d] text-[#8b949e]">\${t}</span>\`).join('')}
                            \${resumen.evolucion ? '<span class="badge bg-purple-500/20 text-purple-400">üìà Actualizado</span>' : ''}
                        </div>
                    </div>
                \`;
            }).join('');

            // Restaurar selecci√≥n
            if (nuevoIdx !== null && nuevoIdx >= 0) {
                conflictoSeleccionado = nuevoIdx;
            }
        }

        function seleccionarFeed(idx) {
            document.querySelectorAll('.feed-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.conflict-item').forEach(el => el.classList.remove('active'));
            
            const item = document.querySelector(\`[data-feed-idx="\${idx}"]\`);
            if (item) item.classList.add('active');

            feedSeleccionado = idx;
            conflictoSeleccionado = null;
            panelActivo = 1;
            
            const entry = feedGlobal[idx];
            const panel = document.getElementById('detalle-panel');

            const titulo = entry.title.includes(' - ') 
                ? entry.title.substring(0, entry.title.lastIndexOf(' - ')) 
                : entry.title;
            const fuente = entry.title.includes(' - ') 
                ? entry.title.substring(entry.title.lastIndexOf(' - ') + 3) 
                : 'Fuente';

            let html = \`
                <div class="border border-[#30363d] bg-[#161b22] rounded-lg p-4 slide-in">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-xl">üì∞</span>
                        <span class="text-[#58a6ff] font-bold">NOTICIA DEL FEED</span>
                    </div>
                    
                    <div class="mb-4">
                        <span class="badge bg-[#21262d] text-[#8b949e] mr-2">\${entry.fuenteRSS}</span>
                        <span class="text-xs text-[#6e7681]">\${formatearFecha(entry.pubDate)}</span>
                    </div>
                    
                    <h3 class="text-white font-medium mb-3">\${titulo}</h3>
                    <p class="text-[#8b949e] text-sm mb-4">Fuente: \${fuente}</p>
                    
                    <a href="\${entry.link}" target="_blank" 
                       class="text-xs text-[#58a6ff] hover:underline break-all block mb-4">
                        üîó \${entry.link.substring(0, 60)}...
                    </a>
            \`;

            if (entry.analisis) {
                const a = entry.analisis;
                html += \`
                    <div class="border-t border-[#30363d] pt-4 mt-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">ü§ñ</span>
                            <span class="text-purple-400 font-bold text-sm">AN√ÅLISIS IA</span>
                        </div>
                        
                        <div class="bg-[#0d1117] rounded p-3 space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-[#8b949e] w-28">¬øEs conflicto?</span>
                                <span class="\${a.es_conflicto ? 'text-green-400' : 'text-red-400'} font-bold">
                                    \${a.es_conflicto ? '‚úì S√ç' : '‚úó NO'}
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[#8b949e] w-28">¬øEn Argentina?</span>
                                <span class="\${a.es_argentina !== false ? 'text-green-400' : 'text-red-400'} font-bold">
                                    \${a.es_argentina !== false ? '‚úì S√ç' : '‚úó NO'}
                                </span>
                            </div>
                            \${a.actor_principal || a.empresa ? \`
                            <div class="flex items-center gap-2">
                                <span class="text-[#8b949e] w-28">Actor:</span>
                                <span class="text-white font-bold">\${a.actor_principal || a.empresa}</span>
                                \${a.tipo_actor ? \`<span class="badge bg-[#21262d] text-[#6e7681]">\${a.tipo_actor}</span>\` : ''}
                            </div>
                            \` : ''}
                            \${a.tipo_conflicto || a.tipo ? \`
                            <div class="flex items-center gap-2">
                                <span class="text-[#8b949e] w-28">Tipo:</span>
                                <span class="badge bg-red-500/20 text-red-400">\${a.tipo_conflicto || a.tipo}</span>
                            </div>
                            \` : ''}
                            \${a.donde ? \`
                            <div class="flex items-center gap-2">
                                <span class="text-[#8b949e] w-28">Ubicaci√≥n:</span>
                                <span class="text-[#58a6ff]">üìç \${a.donde}</span>
                            </div>
                            \` : ''}
                        </div>
                        
                        \${a.es_conflicto && a.es_argentina !== false ? \`
                        <div class="mt-4 bg-[#0d1117] rounded p-3 text-sm">
                            <div class="text-purple-400 font-bold mb-3">üìã RESUMEN DEL CONFLICTO</div>
                            \${a.que_pasa ? \`
                            <div class="resumen-item">
                                <span class="resumen-label">‚ö° Qu√© pasa:</span>
                                <span class="resumen-value">\${a.que_pasa}</span>
                            </div>
                            \` : ''}
                            \${a.protagonistas ? \`
                            <div class="resumen-item">
                                <span class="resumen-label">üë• Qui√©nes:</span>
                                <span class="resumen-value">\${a.protagonistas}</span>
                            </div>
                            \` : ''}
                            \${a.por_que ? \`
                            <div class="resumen-item">
                                <span class="resumen-label">‚ùì Por qu√©:</span>
                                <span class="resumen-value">\${a.por_que}</span>
                            </div>
                            \` : ''}
                            \${a.cuando ? \`
                            <div class="resumen-item">
                                <span class="resumen-label">üìÖ Cu√°ndo:</span>
                                <span class="resumen-value">\${a.cuando}</span>
                            </div>
                            \` : ''}
                            \${a.donde ? \`
                            <div class="resumen-item">
                                <span class="resumen-label">üìç D√≥nde:</span>
                                <span class="resumen-value text-[#58a6ff]">\${a.donde}</span>
                            </div>
                            \` : ''}
                        </div>
                        \` : \`
                        <div class="mt-4 bg-[#0d1117] rounded p-3 text-sm text-[#8b949e]">
                            <p class="text-center">
                                \${!a.es_conflicto ? '‚ùå No se detect√≥ conflicto laboral en este titular' : ''}
                                \${a.es_argentina === false ? '‚ùå El conflicto no es en Argentina' : ''}
                            </p>
                        </div>
                        \`}
                    </div>
                \`;
            } else {
                html += \`
                    <div class="border-t border-[#30363d] pt-4 mt-4 text-center text-[#8b949e]">
                        <div class="flex items-center justify-center gap-2">
                            <div class="spinner w-4 h-4 border-2 border-[#30363d] border-t-[#58a6ff] rounded-full"></div>
                            <span>An√°lisis en curso...</span>
                        </div>
                        <p class="text-xs mt-2 text-[#6e7681]">El resultado aparecer√° autom√°ticamente</p>
                    </div>
                \`;
            }

            html += \`
                <button onclick="window.open('\${entry.link}', '_blank')" 
                        class="w-full mt-4 bg-[#21262d] hover:bg-[#30363d] text-white py-2 px-4 rounded font-medium text-sm">
                    üîó Abrir noticia original
                </button>
            </div>\`;

            panel.innerHTML = html;
        }

        function seleccionarConflicto(idx) {
            document.querySelectorAll('.conflict-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.feed-item').forEach(el => el.classList.remove('active'));
            
            const item = document.querySelector(\`[data-idx="\${idx}"]\`);
            if (item) item.classList.add('active');

            conflictoSeleccionado = idx;
            feedSeleccionado = null;
            panelActivo = 2;
            
            const c = conflictosGlobales[idx];
            const panel = document.getElementById('detalle-panel');

            const tipos = [...new Set(c.noticias.map(n => n.tipo).filter(Boolean))];
            
            // Usar el resumen enriquecido del gestor
            const resumen = c.resumen || {};
            const donde = resumen.donde || 'Argentina';
            const cuando = resumen.cuando || '';
            const quePasa = resumen.que_pasa || '';
            const protagonistas = resumen.protagonistas || '';
            const porQue = resumen.por_que || '';
            const evolucion = resumen.evolucion || '';
            const tipoActor = resumen.tipo_actor || 'empresa';
            
            // Icono seg√∫n tipo de actor
            const icono = tipoActor === 'sector' ? 'üì¶' : 
                          tipoActor === 'gremio' ? 'üë•' : 
                          tipoActor === 'actividad' ? '‚öôÔ∏è' : 'üè≠';
            
            const tipoLabel = tipoActor === 'sector' ? 'SECTOR' : 
                              tipoActor === 'gremio' ? 'GREMIO' : 
                              tipoActor === 'actividad' ? 'ACTIVIDAD' : 'EMPRESA';

            let html = \`
                <div class="border border-[#30363d] bg-[#161b22] rounded-lg p-4 slide-in">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-red-400 font-bold text-xl flex items-center gap-2">
                            \${icono} \${c.empresa.toUpperCase()}
                        </h2>
                        <div class="flex gap-2">
                            <span class="text-xs bg-[#21262d] text-[#8b949e] px-2 py-1 rounded">\${tipoLabel}</span>
                            <span class="text-xs bg-blue-600 text-white px-2 py-1 rounded">üá¶üá∑ Argentina</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mb-4 flex-wrap">
                        \${tipos.map(t => \`<span class="badge bg-red-500/20 text-red-400">\${t}</span>\`).join('')}
                        \${donde ? \`<span class="badge bg-blue-500/20 text-blue-400">üìç \${donde}</span>\` : ''}
                        \${c.noticias.length > 1 ? \`<span class="badge bg-purple-500/20 text-purple-400">üì∞ \${c.noticias.length} fuentes</span>\` : ''}
                    </div>
                    
                    <!-- Resumen del conflicto -->
                    <div class="bg-[#0d1117] rounded-lg p-4 mb-4 border border-[#21262d]">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üìã</span>
                                <span class="text-purple-400 font-bold">RESUMEN DEL CONFLICTO</span>
                            </div>
                            \${c.noticias.length > 1 ? '<span class="text-xs text-purple-400">‚ú® Enriquecido con m√∫ltiples fuentes</span>' : ''}
                        </div>
                        
                        <div class="space-y-3 text-sm">
                            \${donde ? \`
                            <div class="resumen-item">
                                <span class="resumen-label">üìç D√≥nde:</span>
                                <span class="resumen-value text-[#58a6ff]">\${donde}</span>
                            </div>
                            \` : ''}
                            
                            \${cuando ? \`
                            <div class="resumen-item">
                                <span class="resumen-label">üìÖ Cu√°ndo:</span>
                                <span class="resumen-value">\${cuando}</span>
                            </div>
                            \` : ''}
                            
                            \${quePasa ? \`
                            <div class="resumen-item">
                                <span class="resumen-label">‚ö° Qu√© pasa:</span>
                                <span class="resumen-value">\${quePasa}</span>
                            </div>
                            \` : ''}
                            
                            \${protagonistas ? \`
                            <div class="resumen-item">
                                <span class="resumen-label">üë• Qui√©nes:</span>
                                <span class="resumen-value">\${protagonistas}</span>
                            </div>
                            \` : ''}
                            
                            \${porQue ? \`
                            <div class="resumen-item">
                                <span class="resumen-label">‚ùì Por qu√©:</span>
                                <span class="resumen-value">\${porQue}</span>
                            </div>
                            \` : ''}
                            
                            \${evolucion ? \`
                            <div class="resumen-item border-t border-[#30363d] pt-3 mt-3">
                                <span class="resumen-label">üìà Evoluci√≥n:</span>
                                <span class="resumen-value text-yellow-400">\${evolucion}</span>
                            </div>
                            \` : ''}
                        </div>
                    </div>
                    
                    <div class="border-b border-[#30363d] mb-4"></div>
                    
                    <div class="mb-4 flex items-center gap-2">
                        <span class="text-lg">üì∞</span>
                        <span class="font-bold">\${c.noticias.length} fuente\${c.noticias.length > 1 ? 's' : ''} informan:</span>
                    </div>
            \`;

            for (const n of c.noticias) {
                html += \`
                    <div class="mb-4 p-3 bg-[#0d1117] rounded border border-[#21262d]">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-cyan-400 font-medium text-sm">‚ñ∫ \${n.fuente}</span>
                            \${n.tipo ? \`<span class="badge bg-[#21262d] text-[#8b949e]">\${n.tipo}</span>\` : ''}
                        </div>
                        <div class="text-[#c9d1d9] text-sm mb-2">\${n.titulo}</div>
                        <div class="flex items-center justify-between">
                            <a href="\${n.link}" target="_blank" 
                               class="text-xs text-[#8b949e] hover:text-[#58a6ff] underline truncate max-w-[70%]">
                                \${n.link.substring(0, 50)}...
                            </a>
                            <span class="text-xs text-[#6e7681]">\${formatearFecha(n.fecha)}</span>
                        </div>
                    </div>
                \`;
            }

            html += \`
                <button onclick="abrirNoticia()" 
                        class="w-full mt-4 bg-[#238636] hover:bg-[#2ea043] text-white py-2 px-4 rounded font-medium">
                    üîó Abrir primera noticia
                </button>
            </div>\`;

            panel.innerHTML = html;
        }

        function abrirNoticia() {
            if (conflictoSeleccionado !== null && conflictosGlobales[conflictoSeleccionado]) {
                const link = conflictosGlobales[conflictoSeleccionado].noticias[0].link;
                window.open(link, '_blank');
            } else if (feedSeleccionado !== null && feedGlobal[feedSeleccionado]) {
                window.open(feedGlobal[feedSeleccionado].link, '_blank');
            }
        }

        // === CARGA PRINCIPAL ===
        async function cargarConflictos() {
            if (analizando) {
                cancelarAnalisis = true;
                await new Promise(r => setTimeout(r, 500));
            }
            
            cancelarAnalisis = false;
            analizando = true;
            
            mostrarIndicadorAnalisis(true);
            actualizarStatus('Cargando feeds de Argentina...', 'loading');
            estadisticas = { total: 0, conflictos: 0, descartados: 0, pendientes: 0 };
            
            gestorGlobal = new GestorConflictos();
            let todasEntradas = [];

            // Cargar RSS primero (r√°pido)
            for (const fuente of FUENTES_RSS) {
                const entries = await obtenerRSS(fuente);
                todasEntradas = todasEntradas.concat(entries);
            }

            // Renderizar feed crudo inmediatamente (navegable!)
            renderizarFeed(todasEntradas);
            renderizarConflictos([]);
            
            actualizarStatus('Analizando con IA...', 'loading');
            actualizarProgresoAnalisis(0, todasEntradas.length);

            // Procesar cada entrada en segundo plano
            let procesadas = 0;
            for (let i = 0; i < todasEntradas.length; i++) {
                if (cancelarAnalisis) {
                    break;
                }
                
                const entry = todasEntradas[i];
                
                await gestorGlobal.procesarEntrada(entry, i);
                procesadas++;
                
                actualizarProgresoAnalisis(procesadas, todasEntradas.length);
                
                // Actualizar lista de conflictos cada 2 procesadas
                if (procesadas % 2 === 0 || procesadas === todasEntradas.length) {
                    renderizarConflictos(gestorGlobal.obtenerOrdenados(), true);
                }
                
                // Peque√±a pausa para mantener UI responsiva
                await new Promise(r => setTimeout(r, 50));
            }

            analizando = false;
            const conflictos = gestorGlobal.obtenerOrdenados();
            renderizarConflictos(conflictos, true);
            
            actualizarStatus(\`\${conflictos.length} conflictos en Argentina\`, 'normal');
            
            document.getElementById('conflict-status').textContent = 'Orden alfab√©tico A-Z';
        }

        async function recargar() {
            const btn = document.getElementById('reload-btn');
            btn.disabled = true;
            
            cacheAnalisis = {};
            document.getElementById('detalle-panel').innerHTML = \`
                <div class="text-center text-[#8b949e] mt-16">
                    <span class="text-4xl">üëÜ</span>
                    <p class="mt-4">Selecciona un conflicto o noticia</p>
                    <p class="text-xs mt-2">para ver el resumen detallado</p>
                    <p class="text-xs mt-4 text-[#6e7681]">El an√°lisis contin√∫a en segundo plano</p>
                </div>
            \`;
            conflictoSeleccionado = null;
            feedSeleccionado = null;
            
            const icon = document.getElementById('reload-icon');
            icon.classList.add('spinner');
            
            await cargarConflictos();
            
            icon.classList.remove('spinner');
            btn.disabled = false;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ignorar si est√° escribiendo en un input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            if (e.key === 'r' || e.key === 'R') {
                recargar();
            } else if (e.key === 'Enter') {
                abrirNoticia();
            } else if (e.key === '1') {
                panelActivo = 1;
                if (feedGlobal.length > 0) {
                    const idx = feedSeleccionado !== null ? feedSeleccionado : 0;
                    seleccionarFeed(idx);
                }
            } else if (e.key === '2') {
                panelActivo = 2;
                if (conflictosGlobales.length > 0) {
                    const idx = conflictoSeleccionado !== null ? conflictoSeleccionado : 0;
                    seleccionarConflicto(idx);
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (panelActivo === 1 && feedGlobal.length > 0) {
                    const next = feedSeleccionado === null ? 0 : Math.min(feedSeleccionado + 1, feedGlobal.length - 1);
                    seleccionarFeed(next);
                    // Scroll into view
                    document.querySelector(\`[data-feed-idx="\${next}"]\`)?.scrollIntoView({ block: 'nearest' });
                } else if (panelActivo === 2 && conflictosGlobales.length > 0) {
                    const next = conflictoSeleccionado === null ? 0 : Math.min(conflictoSeleccionado + 1, conflictosGlobales.length - 1);
                    seleccionarConflicto(next);
                    document.querySelector(\`[data-idx="\${next}"]\`)?.scrollIntoView({ block: 'nearest' });
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (panelActivo === 1 && feedGlobal.length > 0) {
                    const prev = feedSeleccionado === null ? 0 : Math.max(feedSeleccionado - 1, 0);
                    seleccionarFeed(prev);
                    document.querySelector(\`[data-feed-idx="\${prev}"]\`)?.scrollIntoView({ block: 'nearest' });
                } else if (panelActivo === 2 && conflictosGlobales.length > 0) {
                    const prev = conflictoSeleccionado === null ? 0 : Math.max(conflictoSeleccionado - 1, 0);
                    seleccionarConflicto(prev);
                    document.querySelector(\`[data-idx="\${prev}"]\`)?.scrollIntoView({ block: 'nearest' });
                }
            }
        });

        // Cargar al iniciar
        window.addEventListener('load', cargarConflictos);
    <\/script>
</body>
</html>
`;

      return (
        <>
          {isOpen && <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] fade-in" onClick={onToggle} />}
          <aside className={`fixed inset-0 z-[70] bg-neutral-900 flex flex-col transition-all duration-500 transform ${isOpen ? 'translate-y-0 opacity-100' : 'translate-y-full opacity-0 pointer-events-none'}`}>
            <div className="flex flex-col h-full">
              <div className="p-4 border-b border-neutral-800 flex justify-between items-center bg-neutral-950">
                <div className="flex items-center gap-3">
                  <AlertTriangle className="w-6 h-6 text-orange-500 animate-pulse" />
                  <h3 className="text-xl font-black text-white uppercase tracking-tighter">
                    Monitor de Conflictos <span className="text-neutral-600 ml-2 font-mono text-xs">v2.0 IA</span>
                  </h3>
                </div>
                <div className="flex items-center gap-4">
                  <div className="hidden md:flex items-center gap-2 px-3 py-1 bg-neutral-900 rounded-full border border-neutral-800">
                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span className="text-[10px] text-neutral-400 font-bold uppercase tracking-widest">En Vivo</span>
                  </div>
                  <button onClick={onToggle} className="text-neutral-500 hover:text-white p-2 hover:bg-neutral-800 rounded-full transition-all group">
                    <X className="w-8 h-8 group-hover:rotate-90 transition-transform duration-300" />
                  </button>
                </div>
              </div>
              <div className="flex-1 overflow-hidden bg-black">
                <iframe srcDoc={monitorHtml} className="w-full h-full border-none shadow-2xl" title="Conflict Monitor" />
              </div>
            </div>
          </aside>
        </>
      );
    };



    const StandaloneApp = () => {
      const [news, setNews] = useState([]);
      const [newsLoading, setNewsLoading] = useState(false);
      const [newsError, setNewsError] = useState(false);
      const [sidebarOpen, setSidebarOpen] = useState(true);
      const [protestPanelOpen, setProtestPanelOpen] = useState(false);
      const [conflictMonitorOpen, setConflictMonitorOpen] = useState(false);
      const [sources, setSources] = useState(loadSources);
      const [selectedSources, setSelectedSources] = useState(() => new Set(loadSources().map(s => s.name)));

      const toggleSource = (sourceName) => {
        setSelectedSources(prev => {
          const newSet = new Set(prev);
          if (newSet.has(sourceName)) { newSet.delete(sourceName); }
          else { newSet.add(sourceName); }
          return newSet;
        });
      };

      const toggleAllSources = (selectAll) => {
        if (selectAll) {
          setSelectedSources(new Set(sources.map(s => s.name)));
        } else {
          setSelectedSources(new Set());
        }
      };

      const handleUpdateSources = (newSources) => {
        setSources(newSources);
        saveSources(newSources);
        setSelectedSources(prev => {
          const newSet = new Set(prev);
          newSources.forEach(s => newSet.add(s.name));
          const existingNames = new Set(newSources.map(s => s.name));
          for (const name of prev) {
            if (!existingNames.has(name)) {
              newSet.delete(name);
            }
          }
          return newSet;
        });
      };

      const fetchNews = useCallback(async () => {
        setNewsLoading(true);
        setNewsError(false);
        const allNews = [];
        const activeSources = sources.filter(s => selectedSources.has(s.name));

        try {
          const promises = activeSources.map(async (source) => {
            try {
              const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(source.url)}`);
              const data = await res.json();
              if (data.status === 'ok') {
                return data.items.map((item) => ({
                  title: item.title,
                  link: item.link,
                  pubDate: item.pubDate,
                  source: source.name,
                  description: item.description?.replace(/<[^>]+>/g, '').substring(0, 300) + '...' || '',
                  content: item.content || item.description || ''
                }));
              }
              return [];
            } catch (e) { console.error(`Error fetching ${source.name}:`, e); return []; }
          });

          const results = await Promise.all(promises);
          results.forEach(items => allNews.push(...items));
          allNews.sort((a, b) => new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime());
          setNews(allNews);
        } catch (err) {
          console.error("Error fetching news:", err);
          setNewsError(true);
        } finally {
          setNewsLoading(false);
        }
      }, [selectedSources, sources]);

      useEffect(() => { fetchNews(); }, [fetchNews]);

      return (
        <div className="min-h-screen flex flex-col bg-neutral-950 text-neutral-200">
          <nav className="bg-neutral-900 border-b border-neutral-800 sticky top-0 z-50">
            <div className="container mx-auto px-4 h-16 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <button onClick={() => setSidebarOpen(!sidebarOpen)} className="text-neutral-400 hover:text-white p-2 -ml-2
            transition-all hover:bg-neutral-800 rounded z-50 relative">
                  {sidebarOpen ?
                    <ChevronLeft className="w-5 h-5" /> :
                    <Menu className="w-5 h-5" />}
                </button>
              </div>
              <div className="flex items-center gap-3">
                <button onClick={() => setConflictMonitorOpen(!conflictMonitorOpen)}
                  className={`text-neutral-400 hover:text-white p-2 transition-all hover:bg-neutral-800 rounded z-50 relative
            flex items-center gap-2 ${conflictMonitorOpen ? 'bg-orange-900/20 text-orange-400' : ''
                    }`}
                  title="Mostrar/Ocultar Monitor de Conflictos"
                >
                  <AlertTriangle className="w-5 h-5 text-orange-500" />
                  <span className="text-sm font-medium uppercase">Conflictos</span>
                </button>
                <button onClick={() => setProtestPanelOpen(!protestPanelOpen)}
                  className={`text-neutral-400 hover:text-white p-2 transition-all hover:bg-neutral-800 rounded z-50 relative
            flex items-center gap-2 ${protestPanelOpen ? 'bg-red-900/20 text-red-400' : ''
                    }`}
                  title="Mostrar/Ocultar Panel de Protestas"
                >
                  <Users className="w-5 h-5" />
                  <span className="text-sm font-medium uppercase">Protestas</span>
                </button>
              </div>
            </div>
          </nav>

          <main className="flex-1 bg-neutral-950 relative flex">
            <div
              className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10 pointer-events-none">
            </div>
            <SourcesSidebar sources={sources} selectedSources={selectedSources} onToggleSource={toggleSource}
              onToggleAll={toggleAllSources} isOpen={sidebarOpen} onClose={() => setSidebarOpen(false)}
              onUpdateSources={handleUpdateSources}
            />
            <div className={`flex-1 p-4 md:p-8 relative z-10 transition-all duration-300 ${sidebarOpen ? 'md:ml-80'
              : 'md:ml-0'} ${protestPanelOpen ? 'md:mr-96' : ''}`}>
              <div className="max-w-4xl mx-auto">
                <NewsFeed news={news} loading={newsLoading} error={newsError} onRefresh={fetchNews} />
              </div>
            </div>
          </main>

          {/* Panel de Protestas */}
          <ProtestPanel isOpen={protestPanelOpen} onToggle={() => setProtestPanelOpen(!protestPanelOpen)}
          />

          {/* Monitor de Conflictos */}
          <ConflictMonitorPanel isOpen={conflictMonitorOpen} onToggle={() => setConflictMonitorOpen(!conflictMonitorOpen)}
          />

          <footer className="bg-neutral-900 border-t border-neutral-800 py-6 mt-auto">
            <div
              className="container mx-auto px-4 flex justify-center items-center text-neutral-600 text-[10px] font-mono uppercase tracking-widest">
              <div className="flex items-center gap-2">
                <span>SISTEMA DE CLASIFICACI√ìN</span>
                <span className="text-red-900">‚Ä¢</span>
                <span>PERSPECTIVA DE CLASE</span>
                <span className="text-red-900">‚Ä¢</span>
                <span>Traducci√≥n: MyMemory + Lingva con CORS proxy</span>
              </div>
            </div>
          </footer>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(
      <StandaloneApp />);
  </script>
</body>

</html>
